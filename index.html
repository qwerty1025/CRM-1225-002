<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶ä¸­æ§ç³»çµ± V10 (æ‰¹æ¬¡åŒ¯å…¥ç‰ˆ)</title>
    <style>
        :root {
            --sidebar-width: 240px;
            --sidebar-collapsed: 60px;
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f0f2f5;
            --border: #ddd;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }

        /* å·¦å´æ¬„ */
        .sidebar {
            width: var(--sidebar-width); background: white; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; z-index: 10;
        }
        .sidebar.collapsed { width: var(--sidebar-collapsed); }
        .sidebar.collapsed .sb-text, .sidebar.collapsed .search-box, .sidebar.collapsed .c-info, .sidebar.collapsed .btn-label { display: none; }
        .sidebar.collapsed .c-avatar { display: block; margin: 0 auto; }
        
        .sb-header { padding: 12px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .toggle-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
        .search-box { padding: 10px; border-bottom: 1px solid #eee; }
        .search-box input { width: 100%; padding: 6px; box-sizing: border-box; }
        
        .c-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .c-item { padding: 10px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; align-items: center; height: 45px; }
        .c-item:hover { background: #e3f2fd; }
        .c-item.active { background: #bbdefb; border-left: 4px solid var(--accent); }
        .c-avatar { display: none; width: 32px; height: 32px; background: #eee; border-radius: 50%; text-align: center; line-height: 32px; color: #555; font-weight: bold; }

        /* å´é‚Šæ¬„åº•éƒ¨æŒ‰éˆ•å€ */
        .sb-footer { padding: 10px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 5px; }
        .sb-btn { 
            width: 100%; padding: 8px; border: none; font-weight: bold; cursor: pointer; 
            border-radius: 4px; text-align: left; display: flex; align-items: center; gap: 8px;
        }
        .btn-add { background: #e3f2fd; color: #1565c0; }
        .btn-import { background: #e8f5e9; color: #2e7d32; }
        .btn-import:hover { background: #c8e6c9; }

        /* ä¸»å…§å®¹ */
        .main { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; position: relative; }
        
        .header-bar { background: white; padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-left { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .btn-clone { background: #ff9800; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

        .empty-state { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; }

        /* çŸ©é™£è¨­å®š */
        .config-card { background: white; border-radius: 6px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .matrix-table th { background: #fafafa; padding: 6px; border: 1px solid #eee; color: #666; }
        .matrix-table td { border: 1px solid #eee; padding: 4px; text-align: center; }
        
        .t-btn { 
            display: inline-block; width: 26px; height: 26px; line-height: 26px; 
            border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer; margin: 0 2px; 
            color: #bbb; background: white; font-size: 0.85rem; user-select: none;
        }
        .t-btn.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }

        .pt-row { display: flex; gap: 5px; flex-wrap: wrap; }
        .pt-btn { font-size: 0.75rem; padding: 4px 10px; background: #e0f2f1; color: #00695c; border-radius: 12px; cursor: pointer; border: 1px solid #b2dfdb; }

        /* æ—¥æ›† */
        .cal-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .cal-card { background: white; border-radius: 6px; padding: 8px; border-top: 3px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .cal-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-head { font-size: 0.75rem; text-align: center; color: #aaa; }
        .cal-cell { aspect-ratio: 1; border: 1px solid #f5f5f5; position: relative; cursor: pointer; border-radius: 3px; }
        .date-num { position: absolute; top: 2px; left: 3px; font-size: 0.7rem; color: #666; font-weight: bold; }
        .content-badge {
            position: absolute; bottom: 2px; right: 2px; left: 2px;
            background: rgba(255,255,255,0.9); border: 1px solid #ddd;
            border-radius: 3px; font-size: 0.75rem; text-align: center;
            color: #333; font-weight: bold; padding: 1px 0;
        }
        
        .st-normal { background: #c8e6c9; }
        .st-paused { background: #ffcdd2; }
        .st-missed { background: #fff9c4; border: 1px solid #fbc02d; }
        .st-holiday { background: #f5f5f5; }
        .st-paused .content-badge { text-decoration: line-through; color: #c62828; opacity: 0.7; }

        /* æµ®å‹•æŒ‰éˆ• */
        .fab-group { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; align-items: end; }
        .fab-btn { 
            padding: 12px 20px; border-radius: 30px; border: none; color: white; 
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            display: flex; align-items: center; gap: 5px; transition: transform 0.1s;
        }
        .fab-btn:active { transform: scale(0.95); }
        .btn-save { background: #4caf50; }
        .btn-save-exit { background: #2c3e50; }

        /* åŒ¯å…¥é®ç½© */
        #importModal {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); 
            display:none; justify-content:center; align-items:center; z-index:100;
        }
        .modal-box { background:white; padding:20px; border-radius:8px; text-align:center; width:300px; }

    </style>
</head>
<body>

<nav class="sidebar" id="sidebar">
    <div class="sb-header">
        <span class="sb-text">ğŸ å®¢æˆ¶åˆ—è¡¨</span>
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    </div>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœå°‹å§“å/é›»è©±...">
    </div>
    <ul class="c-list" id="customerList">
        <li style="padding:15px; text-align:center; color:#999; font-size:0.8rem;">è¼‰å…¥ä¸­...</li>
    </ul>
    <div class="sb-footer">
        <button class="sb-btn btn-add" onclick="resetForm(true)">
            <span>+</span> <span class="btn-label">æ–°å¢ç©ºç™½å®¢æˆ¶</span>
        </button>
        <button class="sb-btn btn-import" onclick="document.getElementById('csvInput').click()">
            <span>ğŸ“‚</span> <span class="btn-label">åŒ¯å…¥èˆŠè³‡æ–™ (CSV)</span>
        </button>
        <input type="file" id="csvInput" accept=".csv" style="display:none">
    </div>
</nav>

<main class="main">
    <div id="emptyState" class="empty-state">
        <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨ V10</h2>
        <p>è«‹å¾å·¦å´é¸æ“‡å®¢æˆ¶ï¼Œæˆ–åŒ¯å…¥è³‡æ–™ã€‚</p>
        <p style="font-size:0.8rem; color:#bbb;">è³‡æ–™å·²æ¸…ç©ºï¼Œå®‰å…¨ç„¡è™</p>
    </div>

    <div id="workspace" style="display:none; flex-direction:column; gap:15px;">
        <div class="header-bar">
            <div class="header-left">
                <input type="text" id="inpName" placeholder="å®¢æˆ¶å§“å" style="font-size:1.1rem; font-weight:bold; width:100px; border:none; border-bottom:1px solid #ccc;">
                <input type="text" id="inpPhone" placeholder="é›»è©±" style="width:120px; border:1px solid #eee; padding:3px;">
                <input type="text" id="inpAddr" placeholder="åœ°å€" style="flex:1; border:1px solid #eee; padding:3px; min-width: 150px;">
                <label style="font-size:0.85rem;">$ <input type="number" id="inpPrice" value="35" style="width:40px;"></label>
            </div>
            <button class="btn-clone" onclick="cloneCustomer()">ğŸ“‘ è¤‡è£½æ­¤å–®</button>
        </div>

        <div class="config-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div class="pt-row" id="patternBox"></div>
                <label style="font-size:0.85rem;"><input type="checkbox" id="chkHoliday"> è¦‹ç´…ä¸ä¼‘</label>
            </div>
            <table class="matrix-table">
                <thead>
                    <tr><th style="width:40px;"></th><th>åŸå‘³ (1,2,4,6)</th><th>ç”œå‘³ (1,2)</th><th>å·§å…‹åŠ› (1,2)</th><th>è‰è“ (1,2)</th><th>é»‘ç³– (1,2)</th></tr>
                </thead>
                <tbody id="matrixBody"></tbody>
            </table>
        </div>

        <div class="cal-wrapper" id="calendarGrid"></div>
        <div style="height:60px;"></div>
    </div>
</main>

<div class="fab-group" id="fabGroup" style="display:none;">
    <button class="fab-btn btn-save" onclick="saveData(false)">ğŸ’¾ åƒ…å„²å­˜</button>
    <button class="fab-btn btn-save-exit" onclick="saveData(true)">ğŸ’¾ å„²å­˜ä¸¦çµæŸ</button>
</div>

<div id="importModal">
    <div class="modal-box">
        <h3>è³‡æ–™åŒ¯å…¥ä¸­...</h3>
        <p id="importStatus" style="color:#666; margin:10px 0;">æ­£åœ¨è§£æ...</p>
        <div style="width:100%; background:#eee; height:5px; border-radius:3px; overflow:hidden;">
            <div id="progressBar" style="width:0%; background:var(--accent); height:100%; transition: width 0.3s;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
        authDomain: "crm-1225-003.firebaseapp.com",
        projectId: "crm-1225-003",
        storageBucket: "crm-1225-003.firebasestorage.app",
        messagingSenderId: "566985177794",
        appId: "1:566985177794:web:fcf21c033bd62c3bd7195b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "customers_v10_import"; // å‡ç´šç‚º V10

    // å¸¸æ•¸
    const FLAVORS = ["åŸå‘³", "ç”œå‘³", "å·§å…‹åŠ›", "è‰è“", "é»‘ç³–"];
    const DAYS = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    const PATTERNS = [{l:"å¹³æ—¥",d:[1,2,3,4,5]},{l:"æ¯å¤©",d:[0,1,2,3,4,5,6]},{l:"ä¸€ä¸‰äº”",d:[1,3,5]},{l:"äºŒå››å…­",d:[2,4,6]}];
    const HOLIDAYS = {"2025-12-25":"è–èª•","2026-1-1":"å…ƒæ—¦","2026-2-17":"é™¤å¤•","2026-2-28":"228"};

    let currentId = null;
    let currentMatrix = {};
    let manualOverrides = {}; 
    let startMonth = new Date(2025, 11, 1);

    // --- UI Init ---
    const ptBox = document.getElementById('patternBox');
    PATTERNS.forEach(p => {
        const btn = document.createElement('div');
        btn.className = 'pt-btn'; btn.textContent = p.l; btn.onclick=()=>applyPattern(p.d);
        ptBox.appendChild(btn);
    });

    const mxBody = document.getElementById('matrixBody');
    [1,2,3,4,5,6,0].forEach(dIdx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:bold; color:${dIdx===0||dIdx===6?'red':'#333'}">${DAYS[dIdx]}</td>`;
        FLAVORS.forEach(f => {
            const key = `${dIdx}_${f}`;
            const td = document.createElement('td');
            const opts = (f === "åŸå‘³") ? [1,2,4,6] : [1,2];
            let html = "";
            opts.forEach(v => html += `<span class="t-btn" data-key="${key}" data-val="${v}" onclick="toggleMatrix(this)">${v}</span>`);
            td.innerHTML = html;
            tr.appendChild(td);
        });
        mxBody.appendChild(tr);
    });

    // --- Logic ---
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');

    window.toggleMatrix = (el) => {
        const key = el.dataset.key;
        const val = parseInt(el.dataset.val);
        const active = el.classList.contains('active');
        document.querySelectorAll(`.t-btn[data-key="${key}"]`).forEach(b => b.classList.remove('active'));
        if(active) delete currentMatrix[key];
        else { el.classList.add('active'); currentMatrix[key] = val; }
        renderCal();
    };

    function applyPattern(days) {
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        currentMatrix = {};
        days.forEach(d => {
            const k = `${d}_åŸå‘³`; currentMatrix[k] = 1;
            const b = document.querySelector(`.t-btn[data-key="${k}"][data-val="1"]`);
            if(b) b.classList.add('active');
        });
        renderCal();
    }

    window.cycleState = (dateStr) => {
        let st = manualOverrides[dateStr] || 0;
        st = (st + 1) % 3;
        if(st === 0) delete manualOverrides[dateStr];
        else manualOverrides[dateStr] = st;
        renderCal();
    };

    function renderCal() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const price = parseInt(document.getElementById('inpPrice').value) || 35;
        const doHol = document.getElementById('chkHoliday').checked;

        for(let i=0; i<6; i++) {
            const viewD = new Date(startMonth.getFullYear(), startMonth.getMonth()+i, 1);
            const y = viewD.getFullYear();
            const m = viewD.getMonth();
            const dim = new Date(y, m+1, 0).getDate();
            const fd = new Date(y, m, 1).getDay();
            let mQty = 0; let cells = "";
            for(let k=0; k<fd; k++) cells += `<div></div>`;

            for(let d=1; d<=dim; d++) {
                const dateStr = `${y}-${m+1}-${d}`;
                const dw = new Date(y,m,d).getDay();
                const isHol = HOLIDAYS[dateStr];
                
                let bQty = 0; let txt = "";
                FLAVORS.forEach(f => {
                    const q = currentMatrix[`${dw}_${f}`];
                    if(q) { bQty += q; txt += (f==="åŸå‘³"?"åŸ":f[0]) + q + " "; }
                });

                let st = "st-none"; let fQty = bQty; const ovr = manualOverrides[dateStr];
                if(isHol && !doHol) { st="st-holiday"; fQty=0; }
                else if(ovr === 1) { st="st-paused"; fQty=0; }
                else if(ovr === 2) { st="st-missed"; fQty=0; }
                else if(bQty > 0) st="st-normal";
                mQty += fQty;

                let inner = `<span class="date-num">${d}</span>`;
                if(isHol) inner += `<span style="font-size:0.6rem;color:red;position:absolute;top:2px;right:2px;">${isHol}</span>`;
                if(bQty > 0 || ovr > 0) inner += `<div class="content-badge">${txt}</div>`;
                cells += `<div class="cal-cell ${st}" onclick="cycleState('${dateStr}')">${inner}</div>`;
            }

            const card = document.createElement('div');
            card.className = "cal-card";
            card.innerHTML = `<div class="cal-header"><span>${y}/${m+1}</span><span style="color:var(--accent)">${mQty}ç“¶ | $${mQty*price}</span></div><div class="cal-grid"><div class="cal-head">æ—¥</div><div class="cal-head">ä¸€</div><div class="cal-head">äºŒ</div><div class="cal-head">ä¸‰</div><div class="cal-head">å››</div><div class="cal-head">äº”</div><div class="cal-head">å…­</div>${cells}</div>`;
            grid.appendChild(card);
        }
    }

    // --- CRUD ---
    window.resetForm = (isNew) => {
        currentId = null;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('workspace').style.display = 'flex';
        document.getElementById('fabGroup').style.display = 'flex';
        document.getElementById('inpName').value = "";
        document.getElementById('inpPhone').value = "";
        document.getElementById('inpAddr').value = "";
        document.getElementById('inpPrice').value = 35;
        document.getElementById('chkHoliday').checked = false;
        currentMatrix = {}; manualOverrides = {};
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.c-item').forEach(e => e.classList.remove('active'));
        renderCal();
        if(isNew) document.getElementById('inpName').focus();
    };

    function loadCustomer(id, data) {
        resetForm(false);
        currentId = id;
        document.getElementById('inpName').value = data.name;
        document.getElementById('inpPhone').value = data.phone;
        document.getElementById('inpAddr').value = data.address;
        document.getElementById('inpPrice').value = data.unitPrice;
        document.getElementById('chkHoliday').checked = data.holidayDeliver;
        currentMatrix = data.matrix || {};
        manualOverrides = data.manualOverrides || {};
        Object.keys(currentMatrix).forEach(k => {
            const v = currentMatrix[k];
            const btn = document.querySelector(`.t-btn[data-key="${k}"][data-val="${v}"]`);
            if(btn) btn.classList.add('active');
        });
        renderCal();
    }

    window.cloneCustomer = async () => {
        if(!currentId) return alert("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
        const newName = prompt("æ–°å®¢æˆ¶å§“å:", document.getElementById('inpName').value + "(è¤‡è£½)");
        if(!newName) return;
        const newData = {
            name: newName, phone: "", address: document.getElementById('inpAddr').value,
            unitPrice: parseInt(document.getElementById('inpPrice').value),
            holidayDeliver: document.getElementById('chkHoliday').checked,
            matrix: currentMatrix, manualOverrides: {}, updatedAt: serverTimestamp()
        };
        const ref = await addDoc(collection(db, COL), newData);
        loadCustomer(ref.id, newData);
        alert(`å·²è¤‡è£½ç‚º: ${newName}`);
    };

    window.saveData = async (shouldExit) => {
        const name = document.getElementById('inpName').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        const payload = {
            name: name, phone: document.getElementById('inpPhone').value,
            address: document.getElementById('inpAddr').value,
            unitPrice: parseInt(document.getElementById('inpPrice').value),
            holidayDeliver: document.getElementById('chkHoliday').checked,
            matrix: currentMatrix, manualOverrides: manualOverrides, updatedAt: serverTimestamp()
        };
        if(currentId) await updateDoc(doc(db, COL, currentId), payload);
        else await addDoc(collection(db, COL), payload);

        if(shouldExit) {
            document.getElementById('workspace').style.display = 'none';
            document.getElementById('fabGroup').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            currentId = null;
            alert("âœ… å„²å­˜ä¸¦æ¸…é™¤ç•«é¢");
        } else {
            alert("âœ… å„²å­˜æˆåŠŸ");
        }
    };

    onSnapshot(query(collection(db, COL), orderBy("updatedAt", "desc")), (snap) => {
        const list = document.getElementById('customerList'); list.innerHTML = "";
        snap.forEach(d => {
            const c = d.data();
            const li = document.createElement('li');
            li.className = `c-item ${d.id===currentId?'active':''}`;
            li.innerHTML = `<div class="c-avatar">${c.name[0]}</div><div class="c-info" style="margin-left:10px;flex:1;"><div style="font-weight:bold;font-size:0.95rem;">${c.name}</div><div style="color:#888;font-size:0.8rem;">${c.phone||'-'}</div></div>`;
            li.onclick = () => loadCustomer(d.id, c);
            list.appendChild(li);
        });
    });
    
    document.getElementById('inpPrice').addEventListener('input', renderCal);
    document.getElementById('chkHoliday').addEventListener('change', renderCal);

    // --- CSV Import Engine ---
    document.getElementById('csvInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const text = evt.target.result;
            const rows = text.split(/\r?\n/);
            
            // ç°¡æ˜“è§£æ CSV (å‡è¨­æ²’æœ‰å¼•è™ŸåŒ…è¦†çš„é€—è™Ÿ)
            const headers = rows[0].split(',').map(h => h.trim());
            const dataIdx = {
                name: headers.indexOf("å§“å"),
                phone: headers.indexOf("é›»è©±"),
                addr: headers.indexOf("åœ°å€"),
                price: headers.indexOf("å–®åƒ¹"),
                hol: headers.indexOf("è¦‹ç´…ä¸ä¼‘"),
                days: [headers.indexOf("é€±æ—¥"), headers.indexOf("é€±ä¸€"), headers.indexOf("é€±äºŒ"), headers.indexOf("é€±ä¸‰"), headers.indexOf("é€±å››"), headers.indexOf("é€±äº”"), headers.indexOf("é€±å…­")]
            };

            if(dataIdx.name === -1) return alert("éŒ¯èª¤ï¼šCSV æ‰¾ä¸åˆ° 'å§“å' æ¬„ä½ï¼Œè«‹æª¢æŸ¥æ¨™é¡Œåˆ—ã€‚");

            // UI é¡¯ç¤ºåŒ¯å…¥ä¸­
            document.getElementById('importModal').style.display = 'flex';
            const status = document.getElementById('importStatus');
            const bar = document.getElementById('progressBar');
            
            let count = 0;
            const total = rows.length - 1;
            const batchSize = 400; // Firestore batch limit 500
            
            // è™•ç†è³‡æ–™
            for (let i = 1; i < rows.length; i++) {
                if(!rows[i].trim()) continue;
                const cols = rows[i].split(',').map(c => c.trim());
                
                // è§£ææ¯æ—¥å…§å®¹
                const matrix = {};
                dataIdx.days.forEach((colIdx, dayIdx) => { // dayIdx: 0=Sun ... 6=Sat
                    if(colIdx > -1 && cols[colIdx]) {
                        // æ ¼å¼: "åŸå‘³2,è‰è“1"
                        const items = cols[colIdx].split(/[,ï¼Œ]/);
                        items.forEach(item => {
                            const match = item.match(/([\u4e00-\u9fa5]+)(\d+)/); // æŠ“ä¸­æ–‡+æ•¸å­—
                            if(match) {
                                const flavor = match[1]; // åŸå‘³
                                const qty = parseInt(match[2]);
                                matrix[`${dayIdx}_${flavor}`] = qty;
                            }
                        });
                    }
                });

                const docData = {
                    name: cols[dataIdx.name],
                    phone: dataIdx.phone > -1 ? cols[dataIdx.phone] : "",
                    address: dataIdx.addr > -1 ? cols[dataIdx.addr] : "",
                    unitPrice: dataIdx.price > -1 ? (parseInt(cols[dataIdx.price]) || 35) : 35,
                    holidayDeliver: dataIdx.hol > -1 ? (cols[dataIdx.hol] === "TRUE" || cols[dataIdx.hol] === "æ˜¯") : false,
                    matrix: matrix,
                    manualOverrides: {},
                    updatedAt: serverTimestamp()
                };

                // å¯«å…¥ Firestore (å–®ç­†å¯«å…¥ï¼Œè‹¥é‡å¤§å»ºè­°æ”¹ç”¨ Batch)
                await addDoc(collection(db, COL), docData);
                
                count++;
                const pct = Math.round((count / total) * 100);
                bar.style.width = pct + "%";
                status.textContent = `åŒ¯å…¥ä¸­... (${count}/${total})`;
            }

            document.getElementById('importModal').style.display = 'none';
            alert(`åŒ¯å…¥å®Œæˆï¼å…±æ–°å¢ ${count} ç­†å®¢æˆ¶ã€‚`);
        };
        reader.readAsText(file);
    });

</script>
</body>
</html>