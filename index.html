<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五寮尖羊奶 CRM v5.0 - 旗艦版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], mono: ['"Roboto Mono"', 'monospace'] },
                    colors: { brand: { dark: '#1e293b', accent: '#10b981' } }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; color: #334155; overflow: hidden; font-size: 14px; }
        [v-cloak] { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        
        /* 看板卡片樣式 V5 */
        .kanban-card { 
            border-left-width: 5px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .kanban-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            border-color: inherit;
        }
        
        /* 類型顏色定義 */
        .border-type-morning { border-left-color: #f97316; } /* Orange */
        .border-type-family { border-left-color: #ec4899; } /* Pink */
        .border-type-group { border-left-color: #8b5cf6; } /* Purple */

        /* 狀態 Pill 按鈕樣式 */
        .status-pill {
            @apply px-2 py-0.5 text-[10px] rounded-full border border-slate-200 text-slate-400 font-bold transition-all cursor-pointer select-none hover:bg-slate-50;
        }
        .status-pill.active { @apply text-white border-transparent shadow-sm; }
        .status-pill.billed.active { @apply bg-blue-500; }
        .status-pill.notified.active { @apply bg-amber-500; }
        .status-pill.paid.active { @apply bg-emerald-500; }

        /* Modal 動畫 */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen w-screen flex text-slate-800">

<div id="app" v-cloak class="flex h-full w-full">

    <aside class="w-[64px] bg-slate-900 flex flex-col items-center py-4 shadow-xl z-50 shrink-0">
        <div class="mb-6 w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">五</div>
        
        <nav class="flex-1 flex flex-col gap-4 w-full items-center">
            <button @click="currentView='kanban'" :class="currentView==='kanban'?'text-white bg-slate-700':'text-slate-400'" class="w-10 h-10 rounded-lg flex items-center justify-center transition hover:text-white" title="看板"><i class="fas fa-columns"></i></button>
            <button @click="productModal.show=true" class="w-10 h-10 rounded-lg flex items-center justify-center text-slate-400 hover:text-white transition" title="產品資料庫"><i class="fas fa-box-open"></i></button>
            <button @click="settingsModal.show=true" class="w-10 h-10 rounded-lg flex items-center justify-center text-slate-400 hover:text-white transition" title="系統設定"><i class="fas fa-cog"></i></button>
        </nav>
        
        <div class="mt-auto flex flex-col items-center gap-1 mb-2">
            <div class="w-2.5 h-2.5 rounded-full transition-colors duration-500" :class="isConnected?'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]':'bg-red-500'"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-100 relative h-full">
        
        <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shrink-0 shadow-sm z-20">
            <div class="flex items-center gap-4 flex-1">
                <h1 class="text-lg font-bold text-slate-700 tracking-tight">訂單總覽</h1>
                
                <div class="relative group">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs group-focus-within:text-emerald-500 transition"></i>
                    <input type="text" v-model="filters.search" placeholder="搜尋姓名/地區..." class="pl-8 pr-3 py-1.5 rounded-full bg-slate-100 border-none text-xs focus:ring-2 focus:ring-emerald-500 w-48 transition-all shadow-inner focus:bg-white">
                </div>

                <div class="h-5 w-px bg-slate-200 mx-2"></div>

                <div class="flex gap-1 items-center bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <span class="text-[10px] text-slate-400 font-bold px-1">類型</span>
                    <label v-for="tp in typeOptions" :key="tp" class="cursor-pointer select-none">
                        <input type="checkbox" :value="tp" v-model="filters.type" class="hidden peer">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold text-slate-400 hover:text-slate-600 peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition">{{tp}}</span>
                    </label>
                </div>
                
                <div class="flex gap-1 items-center bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <span class="text-[10px] text-slate-400 font-bold px-1">狀態</span>
                    <label v-for="st in statusOptions" :key="st" class="cursor-pointer select-none">
                        <input type="checkbox" :value="st" v-model="filters.status" class="hidden peer">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold text-slate-400 hover:text-slate-600 peer-checked:bg-white peer-checked:text-slate-800 peer-checked:shadow-sm transition">{{st}}</span>
                    </label>
                </div>
            </div>
            
            <button @click="createNewOrder" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20 transition active:scale-95 flex items-center gap-2">
                <i class="fas fa-plus"></i> 新增訂單
            </button>
        </header>

        <div v-if="loading" class="flex-1 flex flex-col items-center justify-center text-slate-400 gap-2">
            <i class="fas fa-circle-notch animate-spin text-2xl text-emerald-500"></i>
            <span class="text-xs">同步資料中...</span>
        </div>

        <div v-else class="flex-1 overflow-x-auto custom-scroll p-4 bg-slate-100">
            <div class="flex gap-4 h-full min-w-max pb-2">
                <div v-for="st in statusOptions" :key="st" class="w-[340px] flex flex-col bg-slate-200/50 rounded-xl border border-slate-200/60 max-h-full">
                    <div class="px-4 py-2.5 border-b border-slate-200/50 flex justify-between items-center bg-slate-50/80 rounded-t-xl sticky top-0 backdrop-blur z-10">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full" :class="getStatusDotColor(st)"></div>
                            <span class="font-bold text-slate-700 text-sm">{{st}}</span>
                        </div>
                        <span class="bg-white text-slate-400 text-xs px-2 py-0.5 rounded-full font-mono font-bold shadow-sm">{{ filteredOrders.filter(o => o.status === st).length }}</span>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3">
                        <div v-for="order in filteredOrders.filter(o => o.status === st)" :key="order.id" 
                             @click="editOrder(order)"
                             class="kanban-card bg-white p-3 rounded-lg border border-slate-100 cursor-pointer relative overflow-hidden flex flex-col gap-2"
                             :class="getTypeBorderClass(order.type)">
                            
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-slate-800 text-base truncate">{{ order.customerName }}</h3>
                                <span class="text-emerald-600 font-extrabold font-mono text-sm">${{ (order.totalAmount||0).toLocaleString() }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-[11px] text-slate-500">
                                <div class="flex items-center gap-1.5">
                                    <span class="bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 truncate max-w-[120px]">{{ order.productName || order.type }}</span>
                                </div>
                                <span class="font-mono bg-slate-50 px-1.5 py-0.5 rounded text-slate-400">{{ order.area || '-' }}</span>
                            </div>

                            <div class="flex justify-between items-end pt-1 border-t border-slate-50 mt-1">
                                <div class="text-[10px] text-slate-400 font-mono flex items-center gap-1">
                                    <i class="far fa-clock"></i>
                                    {{ formatDateRange(order.dates) }}
                                </div>
                                
                                <div class="flex gap-1" @click.stop>
                                    <div @click="quickStatus(order, '已出帳')" :class="['status-pill billed', order.status === '已出帳' ? 'active' : '']">帳</div>
                                    <div @click="quickStatus(order, '已通知')" :class="['status-pill notified', order.status === '已通知' ? 'active' : '']">知</div>
                                    <div @click="quickStatus(order, '已收款')" :class="['status-pill paid', order.status === '已收款' ? 'active' : '']">收</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <transition name="modal">
        <div v-if="editMode" class="fixed inset-0 z-[100] bg-slate-900/20 backdrop-blur-sm flex overflow-hidden font-sans items-center justify-center">
            
            <div class="bg-white w-full h-full md:w-[98vw] md:h-[95vh] md:rounded-2xl shadow-2xl flex overflow-hidden relative">
                
                <div class="w-[20%] bg-slate-50 border-r border-slate-200 flex flex-col z-20">
                    <div class="p-4 border-b border-slate-200 flex items-center bg-white h-14">
                        <h2 class="font-bold text-slate-700 text-sm"><i class="fas fa-user-edit text-emerald-500 mr-2"></i>訂單資料</h2>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-5">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">顧客姓名</label>
                            <input type="text" v-model="form.customerName" list="cust-list" @change="onCustSelect"
                                class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none shadow-sm placeholder-slate-300" placeholder="輸入姓名...">
                            <datalist id="cust-list"><option v-for="c in savedCustomers" :value="c.name"></option></datalist>
                        </div>

                        <div class="flex gap-2">
                             <div class="flex-1">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">地區</label>
                                <input type="text" v-model="form.area" list="area-list" class="w-full bg-white border border-slate-300 rounded px-2 py-1.5 text-xs outline-none focus:border-emerald-500">
                                <datalist id="area-list"><option v-for="a in uniqueAreas" :value="a"></option></datalist>
                            </div>
                             <div class="w-2/5">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">狀態</label>
                                <select v-model="form.status" class="w-full bg-white border border-slate-300 rounded px-1 py-1.5 text-xs outline-none">
                                    <option v-for="s in statusOptions" :value="s">{{s}}</option>
                                </select>
                            </div>
                        </div>

                        <div class="h-px bg-slate-200 my-2"></div>

                        <div>
                            <label class="block text-[10px] font-bold text-emerald-600 uppercase mb-1">選擇產品 (帶入資料)</label>
                            <select v-model="form.productKey" @change="onProductSelect" class="w-full bg-white border-2 border-emerald-100 rounded-lg px-2 py-2 text-xs outline-none font-bold text-slate-700 mb-3 hover:border-emerald-300 transition cursor-pointer">
                                <option value="">-- 自訂產品 --</option>
                                <optgroup v-for="cat in typeOptions" :key="cat" :label="cat">
                                    <option v-for="p in products.filter(x=>x.category===cat)" :key="p.id" :value="p.id">
                                        {{ p.name }} (${{ p.price }})
                                    </option>
                                </optgroup>
                            </select>
                            
                            <div class="space-y-3 bg-white p-3 rounded-lg border border-slate-100 shadow-sm">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 mb-0.5">品名顯示</label>
                                    <input type="text" v-model="form.productName" class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs focus:bg-white transition">
                                </div>
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <label class="block text-[10px] font-bold text-slate-400 mb-0.5">單價</label>
                                        <input type="number" v-model.number="form.unitPrice" class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs font-mono text-right focus:bg-white transition">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-[10px] font-bold text-slate-400 mb-0.5">歸類</label>
                                        <select v-model="form.type" class="w-full bg-slate-50 border border-slate-200 rounded px-1 py-1 text-[10px] outline-none">
                                            <option v-for="t in typeOptions" :value="t">{{t}}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-[55%] bg-white flex flex-col relative z-10 border-r border-slate-200">
                    
                    <div class="h-14 border-b border-slate-100 flex justify-between items-center px-4 bg-white shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="flex bg-slate-100 rounded p-0.5">
                                <button @click="setDays('weekday')" class="text-[10px] px-3 py-1 rounded font-bold text-slate-500 hover:bg-white hover:shadow-sm transition">平日</button>
                                <button @click="setDays('all')" class="text-[10px] px-3 py-1 rounded font-bold text-slate-500 hover:bg-white hover:shadow-sm transition">全天</button>
                            </div>
                            <div class="h-4 w-px bg-slate-200"></div>
                            <div class="flex items-center gap-1 text-xs">
                                <input type="month" v-model="dateRange.start" class="border border-slate-200 rounded px-1 py-0.5 text-slate-600 font-mono">
                                <span class="text-slate-300">➜</span>
                                <input type="month" v-model="dateRange.end" class="border border-slate-200 rounded px-1 py-0.5 text-slate-600 font-mono">
                            </div>
                        </div>
                    </div>

                    <div class="h-[75%] overflow-y-auto custom-scroll p-4 bg-slate-50/50">
                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="(month, idx) in monthsGrid" :key="idx" 
                                class="bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 flex flex-col overflow-hidden">
                                
                                <div class="px-3 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <span class="font-bold text-slate-700 font-mono text-sm">{{ month.title }}</span>
                                    <span class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-bold border border-emerald-100">
                                        {{ month.total }} 瓶 / ${{ (month.total * form.unitPrice).toLocaleString() }}
                                    </span>
                                </div>

                                <div class="p-3 grid grid-cols-7 gap-1">
                                    <div v-for="w in ['一','二','三','四','五','六','日']" :key="w" class="text-center text-[10px] text-slate-300 font-bold mb-1">{{w}}</div>
                                    <div v-for="n in month.startDay" :key="'p'+n"></div>
                                    <div v-for="d in month.days" :key="d.fullDate"
                                        @click="d.isValid ? toggleQty(d) : null"
                                        :class="['aspect-square rounded-lg flex items-center justify-center text-[11px] relative transition-all duration-100 select-none font-medium',
                                            d.isValid ? (d.qty>0 ? 'bg-emerald-500 text-white font-bold cursor-pointer shadow-md transform scale-105 z-10' : 'bg-white border border-slate-100 text-slate-400 cursor-pointer hover:bg-emerald-50 hover:border-emerald-200') 
                                                      : 'bg-slate-50 opacity-40 text-slate-300 cursor-default']">
                                        {{ d.dateStr }}
                                        <div v-if="d.isSpecial" class="absolute top-1 right-1 w-1.5 h-1.5 bg-purple-400 rounded-full"></div>
                                        <div v-if="d.qty > 1" class="absolute -bottom-1.5 -right-1.5 w-4 h-4 bg-white text-emerald-600 rounded-full flex items-center justify-center text-[9px] border border-emerald-200 shadow-sm font-extrabold">{{ d.qty }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="h-[25%] bg-white border-t border-slate-200 flex flex-col shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                        <div class="px-4 py-2 border-b border-slate-100 text-[10px] font-bold text-slate-400 uppercase flex justify-between items-center bg-slate-50">
                            <span><i class="fas fa-history mr-1"></i>歷史訂購紀錄 (勾選以合併帳單)</span>
                            <span class="bg-slate-200 text-slate-600 px-1.5 rounded">{{ customerHistory.length }}</span>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1">
                            <div v-for="h in customerHistory" :key="h.id" 
                                 class="flex justify-between items-center bg-white border border-slate-100 px-3 py-2 rounded-lg hover:border-emerald-400 cursor-pointer transition group" 
                                 :class="historySelected.includes(h.id) ? 'border-emerald-500 ring-1 ring-emerald-500 bg-emerald-50/10' : ''"
                                 @click="toggleHistorySelect(h)">
                                <div class="flex gap-3 items-center">
                                    <div class="w-4 h-4 rounded flex items-center justify-center border transition" :class="historySelected.includes(h.id)?'bg-emerald-500 border-emerald-500 text-white':'border-slate-300 bg-white group-hover:border-emerald-400'"><i class="fas fa-check text-[9px]" v-show="historySelected.includes(h.id)"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-700 text-xs">{{ h.productName || h.type }}</div>
                                        <div class="text-slate-400 text-[10px]">{{ formatDateRange(h.dates) }}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono text-emerald-600 font-bold text-xs">${{ (h.totalAmount||0).toLocaleString() }}</div>
                                    <div class="text-[9px] text-slate-400">{{ h.status }}</div>
                                </div>
                            </div>
                            <div v-if="customerHistory.length===0" class="flex items-center justify-center h-full text-slate-300 text-xs">無其他訂購紀錄</div>
                        </div>
                    </div>
                </div>

                <div class="w-[25%] bg-slate-50 flex flex-col shadow-xl z-20">
                    
                    <div class="h-28 bg-white border-b border-slate-200 flex flex-col justify-center items-end px-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">本單金額 Estimate</span>
                        <div class="text-4xl font-extrabold text-slate-800 font-mono tracking-tighter">${{ totalAmount.toLocaleString() }}</div>
                        <div class="flex gap-2 mt-2">
                            <span class="text-[10px] text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded-full font-bold">{{ totalCount }} 瓶</span>
                            <span class="text-[10px] text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full font-bold">{{ form.status }}</span>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col p-4 bg-slate-50 relative">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-600"><i class="fas fa-file-invoice-dollar mr-1"></i>帳單預覽</span>
                            <div class="flex bg-white border border-slate-200 rounded p-0.5">
                                <button @click="billMode='detail'" :class="billMode==='detail'?'bg-emerald-500 text-white shadow-sm':'text-slate-400 hover:text-slate-600'" class="px-2 py-0.5 text-[10px] rounded transition font-bold">明細</button>
                                <button @click="billMode='month'" :class="billMode==='month'?'bg-emerald-500 text-white shadow-sm':'text-slate-400 hover:text-slate-600'" class="px-2 py-0.5 text-[10px] rounded transition font-bold">月結</button>
                            </div>
                        </div>
                        
                        <textarea readonly class="flex-1 w-full bg-white border border-slate-200 rounded-lg p-3 text-xs font-mono text-slate-600 outline-none resize-none leading-relaxed shadow-sm focus:border-emerald-300 transition" :value="generatedBill"></textarea>
                        
                        <div class="mt-3 p-2 bg-blue-50 border border-blue-100 rounded-lg text-[10px] text-blue-600 leading-tight flex gap-2">
                            <i class="fas fa-info-circle mt-0.5"></i>
                            <span>若同日配送不同商品，請分別建立訂單，並勾選「歷史紀錄」合併列印。</span>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-200 bg-white space-y-3">
                        <div class="flex gap-2">
                             <button @click="copyBill" class="flex-1 bg-white border border-slate-300 text-slate-600 py-3 rounded-xl text-xs font-bold hover:bg-slate-50 active:scale-95 transition">複製內文</button>
                             <button @click="saveOrder" :disabled="isSaving" class="flex-[2] bg-emerald-600 text-white py-3 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 active:scale-95 transition flex justify-center items-center gap-2">
                                <i v-if="isSaving" class="fas fa-circle-notch animate-spin"></i>
                                <span v-else>儲存訂單</span>
                             </button>
                        </div>
                        <div class="flex justify-between items-center pt-1">
                            <button @click="closeEdit" class="text-slate-400 text-xs hover:text-slate-600">取消</button>
                            <button v-if="form.id" @click="deleteOrder" class="text-red-300 text-xs hover:text-red-500 font-bold">刪除訂單</button>
                        </div>
                    </div>
                </div>

                <button @click="closeEdit" class="absolute top-2 right-2 w-8 h-8 bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full flex items-center justify-center transition z-50 md:hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </transition>

    <transition name="modal">
        <div v-if="productModal.show" class="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center" @click.self="productModal.show=false">
            <div class="bg-white rounded-2xl shadow-2xl w-[500px] max-h-[80vh] flex flex-col overflow-hidden border border-slate-200">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-700"><i class="fas fa-box-open text-emerald-500 mr-2"></i>產品資料庫</h3>
                    <button @click="productModal.show=false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">新增產品 Template</div>
                        <div class="flex gap-2">
                            <select v-model="newProduct.category" class="bg-white border border-slate-300 rounded-lg px-2 py-2 text-xs w-1/4 outline-none">
                                <option v-for="t in typeOptions" :value="t">{{t}}</option>
                            </select>
                            <input type="text" v-model="newProduct.name" placeholder="產品名稱 (例: 鮮羊奶)" class="bg-white border border-slate-300 rounded-lg px-3 py-2 text-xs flex-1 outline-none">
                            <input type="number" v-model.number="newProduct.price" placeholder="$" class="bg-white border border-slate-300 rounded-lg px-2 py-2 text-xs w-16 text-center outline-none">
                            <button @click="addProduct" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 rounded-lg text-xs shadow-md transition active:scale-95"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <div v-for="cat in typeOptions" :key="cat">
                        <div class="text-xs font-bold text-slate-500 mb-2 pl-2 border-l-4 border-emerald-500">{{ cat }}</div>
                        <div class="space-y-2">
                            <div v-for="p in products.filter(x=>x.category===cat)" :key="p.id" class="flex justify-between items-center bg-white border border-slate-100 px-4 py-3 rounded-lg hover:border-emerald-200 hover:shadow-sm transition group">
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">#{{p.code}}</span>
                                    <span class="text-sm font-bold text-slate-700">{{p.name}}</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-mono text-emerald-600 font-bold">${{p.price}}</span>
                                    <button @click="removeProduct(p.id)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div v-if="products.filter(x=>x.category===cat).length===0" class="text-[10px] text-slate-300 italic pl-4">無產品</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>
    
    <transition name="modal">
        <div v-if="settingsModal.show" class="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center" @click.self="settingsModal.show=false">
            <div class="bg-white rounded-2xl shadow-2xl w-[400px] h-[500px] flex flex-col border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-slate-700">系統設定</h3>
                    <button @click="settingsModal.show=false"><i class="fas fa-times text-slate-400"></i></button>
                </div>
                <div class="p-4 overflow-y-auto custom-scroll flex-1">
                    <div class="mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider">全域假日設定 (不配送)</div>
                    <div class="flex gap-2 mb-4">
                        <input type="date" v-model="newHoliday.date" class="border border-slate-300 rounded-lg px-2 py-2 text-xs flex-1 outline-none">
                        <input type="text" v-model="newHoliday.name" placeholder="原因" class="border border-slate-300 rounded-lg px-2 py-2 text-xs flex-1 outline-none">
                        <button @click="addHoliday" class="bg-emerald-600 text-white px-3 rounded-lg text-xs shadow hover:bg-emerald-700"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="(name, date) in holidays" :key="date" class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100 text-xs">
                            <span class="font-mono text-slate-600">{{date}} <span class="text-purple-500 font-bold ml-2">{{name}}</span></span>
                            <button @click="removeHoliday(date)" class="text-slate-300 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref as dbRef, push, onValue, update, remove, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Config provided by user
    const firebaseConfig = {
        apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
        authDomain: "crm-ts-1225-001.firebaseapp.com",
        databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
        projectId: "crm-ts-1225-001",
        storageBucket: "crm-ts-1225-001.firebasestorage.app",
        messagingSenderId: "925760221722",
        appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            // --- State ---
            const isConnected = ref(false);
            const loading = ref(true);
            const currentView = ref('kanban');
            const orders = ref([]);
            const products = ref([]);
            const holidays = ref({});
            const savedCustomers = ref([]); // For Autocomplete cache
            
            // Filters & Options
            const filters = reactive({ search: '', status: ['暫存','已通知','已出帳','已收款'], type: ['晨間','家庭號','團購'] });
            const statusOptions = ['暫存', '已通知', '已出帳', '已收款'];
            const typeOptions = ['晨間', '家庭號', '團購'];
            
            // Edit Mode State
            const editMode = ref(false);
            const isSaving = ref(false);
            const dateRange = reactive({ start: '2025-01', end: '2025-03' });
            const form = reactive({
                id: null, customerName: '', area: '', status: '暫存', type: '晨間',
                productKey: '', productName: '', unitPrice: 35,
                dates: {}
            });
            const historySelected = ref([]); // Store IDs of other orders to merge
            const billMode = ref('detail');
            
            // Modals State
            const productModal = reactive({ show: false });
            const settingsModal = reactive({ show: false });
            const newProduct = reactive({ category: '晨間', name: '', price: 35 });
            const newHoliday = reactive({ date: '', name: '' });

            // --- Initialization ---
            onMounted(() => {
                onValue(dbRef(db, '.info/connected'), s => isConnected.value = s.val());
                
                // Load Orders
                onValue(dbRef(db, 'orders'), s => {
                    const data = s.val();
                    orders.value = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
                    loading.value = false;
                    
                    // Update Customers List (Simple unique mechanism)
                    const custMap = {};
                    orders.value.forEach(o => { 
                        if(o.customerName) custMap[o.customerName] = { name: o.customerName, area: o.area }; 
                    });
                    savedCustomers.value = Object.values(custMap);
                });

                // Load Products
                onValue(dbRef(db, 'products'), s => {
                    const data = s.val();
                    products.value = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
                });

                // Load Holidays
                onValue(dbRef(db, 'holidays'), s => holidays.value = s.val() || {});
            });

            // --- Computed Properties ---
            
            const filteredOrders = computed(() => {
                const sTerm = filters.search.toLowerCase();
                return orders.value.filter(o => {
                    return filters.status.includes(o.status || '暫存') &&
                           filters.type.includes(o.type || '晨間') &&
                           (!sTerm || (o.customerName||'').toLowerCase().includes(sTerm) || (o.area||'').toLowerCase().includes(sTerm));
                }).sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
            });

            const uniqueAreas = computed(() => [...new Set(savedCustomers.value.map(c=>c.area).filter(Boolean))]);

            // Calendar Logic (Center Top)
            const monthsGrid = computed(() => {
                if(!dateRange.start || !dateRange.end) return [];
                const grids = [];
                const [sy, sm] = dateRange.start.split('-').map(Number);
                const [ey, em] = dateRange.end.split('-').map(Number);
                let curr = new Date(sy, sm-1, 1);
                const end = new Date(ey, em, 0);

                while(curr <= end) {
                    const y = curr.getFullYear(), m = curr.getMonth();
                    const title = `${y}-${String(m+1).padStart(2,'0')}`;
                    const daysInMonth = new Date(y, m+1, 0).getDate();
                    const startDay = (new Date(y, m, 1).getDay() + 6) % 7; // Mon=0 adjustment
                    
                    const days = [];
                    let mTotal = 0;
                    for(let d=1; d<=daysInMonth; d++) {
                        const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const qty = form.dates[dateStr] || 0;
                        mTotal += qty;
                        days.push({
                            dateStr: d, fullDate: dateStr, qty: qty,
                            isValid: true, isSpecial: !!holidays.value[dateStr]
                        });
                    }
                    grids.push({ title, days, startDay, total: mTotal });
                    curr = new Date(y, m+1, 1);
                }
                return grids;
            });

            const totalCount = computed(() => Object.values(form.dates).reduce((a,b)=>a+b,0));
            const totalAmount = computed(() => totalCount.value * (form.unitPrice || 0));

            // History Logic (Center Bottom)
            const customerHistory = computed(() => {
                if(!form.customerName) return [];
                // Exclude current editing order
                return orders.value.filter(o => o.customerName === form.customerName && o.id !== form.id)
                    .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
            });

            // Bill Generation Logic (Right)
            const generatedBill = computed(() => {
                // Combine current form data + selected history items
                const targets = [
                    { 
                        ...form, 
                        totalCount: totalCount.value, 
                        totalAmount: totalAmount.value 
                    }, 
                    ...customerHistory.value.filter(h => historySelected.value.includes(h.id))
                ];
                
                let text = `【${targets[0].customerName}】配送帳單\n`;
                let grandTotalQty = 0;
                let grandTotalAmt = 0;

                targets.forEach((o, index) => {
                    const range = formatDateRange(o.dates);
                    const name = o.productName || o.type;
                    
                    if (index > 0) text += `------------------------\n`; // Separator for merged orders
                    text += `品項：${name}\n期間：${range}\n`;
                    
                    if(billMode.value === 'detail') {
                        // Detailed view: Group by Month
                        const byMonth = {};
                        Object.entries(o.dates||{}).forEach(([d,q]) => {
                            if(q>0) {
                                const m = d.substring(0,7);
                                if(!byMonth[m]) byMonth[m]=[];
                                byMonth[m].push(`${parseInt(d.split('-')[2])}${q>1?'*'+q:''}`);
                            }
                        });
                        // Sort months
                        Object.keys(byMonth).sort().forEach(m => {
                             text += `  ${m.split('-')[1]}月: ${byMonth[m].join('、')}\n`;
                        });
                    } else {
                        // Summary view
                        const byMonth = {};
                        Object.entries(o.dates||{}).forEach(([d,q]) => {
                             const m = d.substring(0,7);
                             byMonth[m] = (byMonth[m]||0) + q;
                        });
                        Object.keys(byMonth).sort().forEach(m => {
                            text += `  ${m.split('-')[1]}月: 共${byMonth[m]}瓶\n`;
                        });
                    }
                    text += `  小計：${o.totalCount||0}瓶 $${(o.totalAmount||0).toLocaleString()}\n`;
                    grandTotalQty += (o.totalCount||0);
                    grandTotalAmt += (o.totalAmount||0);
                });

                text += `========================\n`;
                text += `總計：${grandTotalQty} 瓶\n`;
                text += `應收金額：NT$${grandTotalAmt.toLocaleString()}\n`;
                text += `(請核對無誤後匯款，謝謝)`;
                return text;
            });

            // --- Methods ---

            // Card Operations
            const quickStatus = async (order, status) => {
                // Toggle logic: if clicked same status, maybe revert to Draft? Or just set.
                // Here we just set it.
                if(order.status === status) status = '暫存'; 
                await update(dbRef(db, `orders/${order.id}`), { status, updatedAt: Date.now() });
            };

            const createNewOrder = () => {
                form.id=null; form.customerName=''; form.area=''; form.status='暫存'; form.type='晨間';
                form.productKey=''; form.productName=''; form.unitPrice=35; form.dates={};
                historySelected.value = [];
                // Default range
                const today = new Date();
                const nm = new Date(); nm.setMonth(today.getMonth()+2);
                dateRange.start = today.toISOString().slice(0,7);
                dateRange.end = nm.toISOString().slice(0,7);
                editMode.value = true;
            };

            const editOrder = (o) => {
                form.id=o.id; form.customerName=o.customerName; form.area=o.area; form.status=o.status; form.type=o.type;
                form.productKey=o.productKey||''; form.productName=o.productName||''; form.unitPrice=o.unitPrice||35;
                // Deep copy dates to avoid reactivity issues on cancel
                form.dates = o.dates ? JSON.parse(JSON.stringify(o.dates)) : {};
                historySelected.value = [];
                
                // Smart Date Range: Cover the existing dates
                const keys = Object.keys(form.dates).sort();
                if(keys.length > 0) {
                    dateRange.start = keys[0].substring(0,7);
                    dateRange.end = keys[keys.length-1].substring(0,7);
                }
                editMode.value = true;
            };

            const closeEdit = () => editMode.value = false;

            // Form Logic
            const onCustSelect = () => {
                const found = savedCustomers.value.find(c => c.name === form.customerName);
                if(found) form.area = found.area;
            };

            const onProductSelect = () => {
                const p = products.value.find(x => x.id === form.productKey);
                if(p) {
                    form.productName = p.name;
                    form.unitPrice = p.price;
                    form.type = p.category;
                }
            };

            // Calendar Actions
            const setDays = (mode) => {
                const [sy, sm] = dateRange.start.split('-').map(Number);
                const [ey, em] = dateRange.end.split('-').map(Number);
                let curr = new Date(sy, sm-1, 1);
                const end = new Date(ey, em, 0);
                
                // 1-5 for weekday, 0-6 for all
                const targetDays = mode==='weekday' ? [1,2,3,4,5] : [0,1,2,3,4,5,6];
                
                while(curr <= end) {
                    const dateStr = curr.toISOString().split('T')[0];
                    const day = curr.getDay();
                    const isHoliday = !!holidays.value[dateStr];
                    
                    if(targetDays.includes(day) && !isHoliday) {
                        // Only add if not exist (don't overwrite qty)
                        if(!form.dates[dateStr]) form.dates[dateStr] = 1;
                    }
                    curr.setDate(curr.getDate()+1);
                }
            };

            const toggleQty = (d) => {
                const q = form.dates[d.fullDate] || 0;
                // Cycle: 0 -> 1 -> 2 -> 0
                const next = q === 0 ? 1 : (q === 1 ? 2 : 0);
                if(next === 0) delete form.dates[d.fullDate];
                else form.dates[d.fullDate] = next;
            };

            const toggleHistorySelect = (h) => {
                const idx = historySelected.value.indexOf(h.id);
                if(idx > -1) historySelected.value.splice(idx,1);
                else historySelected.value.push(h.id);
            };

            // Database Actions
            const saveOrder = async () => {
                if(!form.customerName) return alert('請輸入姓名');
                isSaving.value = true;
                const payload = { 
                    ...form, 
                    totalAmount: totalAmount.value, 
                    totalCount: totalCount.value,
                    updatedAt: Date.now() 
                };
                
                if(form.id) await update(dbRef(db, `orders/${form.id}`), payload);
                else {
                    payload.createdAt = Date.now();
                    await push(dbRef(db, 'orders'), payload);
                }
                isSaving.value = false;
                closeEdit();
            };
            
            const deleteOrder = async () => {
                if(confirm('確定刪除此訂單?')) {
                    await remove(dbRef(db, `orders/${form.id}`));
                    closeEdit();
                }
            };

            const copyBill = () => navigator.clipboard.writeText(generatedBill.value).then(()=>alert('複製成功'));

            // Product DB Logic
            const addProduct = async () => {
                if(!newProduct.name) return;
                const code = Math.random().toString(36).substr(2, 4).toUpperCase();
                await push(dbRef(db, 'products'), { ...newProduct, code });
                newProduct.name=''; newProduct.price=35;
            };
            const removeProduct = (id) => confirm('刪除此產品?') && remove(dbRef(db, `products/${id}`));

            // Holiday Logic
            const addHoliday = () => {
                if(!newHoliday.date) return;
                update(dbRef(db, 'holidays'), { [newHoliday.date]: newHoliday.name || '休假' });
                newHoliday.date=''; newHoliday.name='';
            };
            const removeHoliday = (d) => remove(dbRef(db, `holidays/${d}`));

            // Visual Helpers
            const getTypeBorderClass = (t) => t==='家庭號'?'border-type-family':(t==='團購'?'border-type-group':'border-type-morning');
            const getStatusDotColor = (s) => {
                switch(s) {
                    case '已出帳': return 'bg-blue-500';
                    case '已通知': return 'bg-amber-500';
                    case '已收款': return 'bg-emerald-500';
                    default: return 'bg-slate-300';
                }
            };
            const formatDateRange = (dates) => {
                if(!dates) return '無日期';
                const keys = Object.keys(dates).sort();
                if(keys.length===0) return '無日期';
                return `${keys[0].substring(5)} ~ ${keys[keys.length-1].substring(5)}`;
            };

            return {
                isConnected, loading, currentView, orders, products, holidays, savedCustomers,
                filters, statusOptions, typeOptions, uniqueAreas, filteredOrders,
                editMode, form, dateRange, monthsGrid, totalCount, totalAmount, customerHistory, historySelected,
                productModal, settingsModal, newProduct, newHoliday,
                billMode, generatedBill,
                createNewOrder, editOrder, closeEdit, saveOrder, deleteOrder, quickStatus,
                onCustSelect, onProductSelect, setDays, toggleQty, toggleHistorySelect, copyBill,
                addProduct, removeProduct, addHoliday, removeHoliday,
                getTypeBorderClass, getStatusDotColor, formatDateRange
            };
        }
    }).mount('#app');
</script>
</body>
</html>