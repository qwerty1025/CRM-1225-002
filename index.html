<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç³»çµ± v8.0 - çµ‚æ¥µé€£ç·šè¨ºæ–·ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ã€è«‹æ³¨æ„ã€‘å¦‚æœæ‚¨çš„è³‡æ–™åº«ä¸æ˜¯é–‹åœ¨ç¾åœ‹ï¼Œè«‹æ‰‹å‹•æ›¿æ›ä¸‹æ–¹çš„ databaseURL
        const firebaseConfig = {
            apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
            authDomain: "crm-1225-003.firebaseapp.com",
            projectId: "crm-1225-003",
            storageBucket: "crm-1225-003.firebasestorage.app",
            messagingSenderId: "566985177794",
            appId: "1:566985177794:web:fcf21c033bd62c3bd7195b",
            databaseURL: "https://crm-1225-003-default-rtdb.firebaseio.com" 
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getDatabase(app);
            window.dbRef = ref;
            window.dbSet = set;
            window.dbUpdate = update;
            window.dbRemove = remove;
            window.dbPush = push;
            window.dbOnValue = onValue;
            console.log("Firebase App åˆå§‹åŒ–æˆåŠŸ");
        } catch(e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
            alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        
        <div class="p-2 text-white text-xs flex justify-between items-center" :class="connectionStatus === 'connected' ? 'bg-emerald-600' : 'bg-rose-600'">
            <div class="flex gap-4">
                <span class="font-bold">é€£ç·šç‹€æ…‹: {{ connectionStatusText }}</span>
                <span>(å°ˆæ¡ˆ: crm-1225-003)</span>
            </div>
            <div class="font-mono">{{ lastPing }}</div>
        </div>

        <nav class="bg-white p-4 shadow flex justify-between items-center">
            <h1 class="font-bold text-lg">é…é€ç³»çµ± v8.0 <span class="text-xs text-gray-400">è¨ºæ–·æ¨¡å¼</span></h1>
            <div class="flex gap-2">
                <button @click="view='manager'" :class="view==='manager'?'bg-blue-600 text-white':'bg-gray-200'" class="px-4 py-1 rounded">ç¶“ç†</button>
                <button @click="view='delivery'" :class="view==='delivery'?'bg-green-600 text-white':'bg-gray-200'" class="px-4 py-1 rounded">é…é€</button>
            </div>
        </nav>

        <main class="p-4 max-w-5xl mx-auto w-full space-y-6">

            <div v-if="view === 'manager'" class="bg-white p-6 rounded-xl shadow-lg border-2 border-indigo-100">
                <h2 class="font-bold text-lg mb-2 text-indigo-900">ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šé€£ç·šèˆ‡å¯«å…¥æ¸¬è©¦</h2>
                <p class="text-sm text-gray-500 mb-4">å¦‚æœä¸‹æ–¹çœ‹æ¿æ²’æœ‰è³‡æ–™ï¼Œè«‹å…ˆé»æ“Šæ­¤æŒ‰éˆ•ã€‚ç³»çµ±æœƒå˜—è©¦å¯«å…¥ä¸€æ¢æ¸¬è©¦æ•¸æ“šï¼Œä¸¦å‘Šè¨´æ‚¨éŒ¯èª¤åŸå› ã€‚</p>
                
                <div class="flex gap-4">
                    <button @click="forceTestWrite" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-indigo-700">
                        ğŸš€ ç™¼é€æ¸¬è©¦å°åŒ… (Test Write)
                    </button>
                    <div class="flex-grow bg-black text-green-400 font-mono text-xs p-3 rounded h-24 overflow-y-auto">
                        <div v-for="(log, i) in debugLogs" :key="i">[{{ log.time }}] {{ log.msg }}</div>
                    </div>
                </div>
            </div>

            <div v-if="view === 'manager'" class="bg-white p-6 rounded-xl shadow border border-gray-200">
                <h2 class="font-bold mb-4">â• æ–°å¢å®¢æˆ¶è³‡æ–™ (å¯«å…¥æ¸¬è©¦)</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input v-model.number="form.order" type="number" placeholder="é †åº" class="border p-2 rounded">
                    <input v-model="form.name" type="text" placeholder="å§“å" class="border p-2 rounded">
                    <select v-model="form.area" class="border p-2 rounded"><option>å¤§åŸ”</option><option>ä¸‰å³½</option></select>
                    <select v-model="form.cycle" class="border p-2 rounded"><option>æ¯å¤©</option></select>
                </div>
                <div v-if="previewList.length > 0" class="mb-4 bg-amber-50 p-4 rounded border border-amber-200">
                    <h3 class="font-bold text-amber-800 mb-2">å¾…ä¸Šå‚³æ¸…å–® ({{ previewList.length }})</h3>
                    <div v-for="p in previewList" class="text-xs mb-1 border-b pb-1">
                        {{ p.order }}. {{ p.name }} ({{ p.area }})
                    </div>
                    <button @click="confirmRealUpload" class="mt-2 bg-amber-600 text-white px-4 py-2 rounded w-full font-bold">
                        ç¢ºèªå¯«å…¥é›²ç«¯ (Real Upload)
                    </button>
                </div>
                <button @click="addToPreview" class="bg-gray-800 text-white px-4 py-2 rounded w-full">åŠ å…¥é è¦½</button>
            </div>

            <div v-if="view === 'manager'" class="bg-white p-6 rounded-xl shadow border border-gray-200 min-h-[300px]">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="font-bold text-lg flex items-center gap-2">
                        ğŸ“¡ é›²ç«¯è³‡æ–™å³æ™‚çœ‹æ¿ 
                        <span v-if="customersList.length === 0" class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded">ç›®å‰ç„¡è³‡æ–™æˆ–è®€å–å¤±æ•—</span>
                        <span v-else class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">å·²è®€å– {{ customersList.length }} ç­†</span>
                    </h2>
                    <button @click="reloadPage" class="text-xs text-blue-500 underline">é‡æ–°æ•´ç†ç¶²é </button>
                </div>

                <div v-if="loading" class="text-center py-10 text-gray-400 animate-pulse">æ­£åœ¨å˜—è©¦è®€å–è³‡æ–™åº«...</div>

                <div v-else class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3">ID (Key)</th>
                                <th class="p-3">é †åº</th>
                                <th class="p-3">å§“å</th>
                                <th class="p-3">å€åŸŸ</th>
                                <th class="p-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="c in customersList" :key="c.id" class="border-b hover:bg-blue-50">
                                <td class="p-3 font-mono text-xs text-gray-400">{{ c.id }}</td>
                                <td class="p-3 font-bold">{{ c.order }}</td>
                                <td class="p-3 font-bold text-blue-700">{{ c.name }}</td>
                                <td class="p-3">{{ c.area }}</td>
                                <td class="p-3">
                                    <button @click="deleteItem(c.id)" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs hover:bg-red-200">åˆªé™¤</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="customersList.length === 0 && !loading" class="text-center py-10 text-gray-400">
                        <p>è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„ï¼Œæˆ–æ˜¯è®€å–æ¬Šé™è¢«æ‹’ã€‚</p>
                        <p class="text-xs mt-2">è«‹å˜—è©¦ä¸Šæ–¹çš„ã€Œç™¼é€æ¸¬è©¦å°åŒ…ã€æŒ‰éˆ•ã€‚</p>
                    </div>
                </div>
            </div>

            <div v-if="view === 'delivery'" class="text-center py-10">
                <h3 class="font-bold text-gray-500">é…é€å“¡ä»‹é¢éœ€ç­‰å¾…è³‡æ–™åº«é€£ç·šæˆåŠŸå¾Œé¡¯ç¤ºè³‡æ–™</h3>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const view = ref('manager');
                const connectionStatus = ref('disconnected');
                const lastPing = ref('');
                const debugLogs = ref([]);
                const customers = ref({});
                const loading = ref(true);
                const previewList = ref([]);
                const form = reactive({ order: 1, name: '', area: 'å¤§åŸ”', cycle: 'æ¯å¤©', pattern: new Array(35).fill(0) });

                // ç´€éŒ„ Log
                const log = (msg) => {
                    const time = new Date().toLocaleTimeString();
                    debugLogs.value.unshift({ time, msg });
                    console.log(`[App Log] ${msg}`);
                };

                // ç›£è½é€£ç·šç‹€æ…‹
                onMounted(() => {
                    log("æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•ï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«...");
                    
                    // 1. ç›£è½ .info/connected (Firebase å…§å»ºé€£ç·šç‹€æ…‹)
                    const connectedRef = window.dbRef(window.db, ".info/connected");
                    window.dbOnValue(connectedRef, (snap) => {
                        if (snap.val() === true) {
                            connectionStatus.value = 'connected';
                            lastPing.value = `Ping: ${new Date().toLocaleTimeString()}`;
                            log("ğŸŸ¢ Firebase ä¼ºæœå™¨å·²é€£ç·š (Client Connected)");
                        } else {
                            connectionStatus.value = 'disconnected';
                            log("ğŸ”´ èˆ‡ Firebase ä¼ºæœå™¨æ–·ç·š (Client Disconnected)");
                        }
                    });

                    // 2. ç›£è½ customers ç¯€é»
                    const custRef = window.dbRef(window.db, 'customers');
                    window.dbOnValue(custRef, (snap) => {
                        loading.value = false;
                        const val = snap.val();
                        if (val) {
                            customers.value = val;
                            log(`ğŸ“– æˆåŠŸè®€å–åˆ° ${Object.keys(val).length} ç­†å®¢æˆ¶è³‡æ–™`);
                        } else {
                            customers.value = {};
                            log("ğŸ“– è®€å–æˆåŠŸï¼Œä½† 'customers' ç¯€é»ç›®å‰ç‚ºç©º (null)");
                        }
                    }, (error) => {
                        loading.value = false;
                        log(`âŒ è®€å–å¤±æ•— (Permission Denied?): ${error.message}`);
                        alert(`è®€å–è¢«æ‹’çµ•ï¼è«‹æª¢æŸ¥ Rulesã€‚\néŒ¯èª¤ä»£ç¢¼: ${error.code}`);
                    });
                });

                const connectionStatusText = computed(() => {
                    return connectionStatus.value === 'connected' ? 'å·²é€£ç·š (Online)' : 'æ–·ç·šä¸­ (Offline)';
                });

                // å¼·åˆ¶å¯«å…¥æ¸¬è©¦
                const forceTestWrite = async () => {
                    log("ğŸš€ é–‹å§‹åŸ·è¡Œå¼·åˆ¶å¯«å…¥æ¸¬è©¦...");
                    const testRef = window.dbRef(window.db, '_debug_test_write_' + Date.now());
                    try {
                        await window.dbSet(testRef, {
                            msg: "Hello Firebase",
                            timestamp: Date.now()
                        });
                        log("âœ… å¯«å…¥æ¸¬è©¦æˆåŠŸï¼è³‡æ–™åº«æ¬Šé™æ­£å¸¸ã€‚");
                        alert("å¯«å…¥æ¸¬è©¦æˆåŠŸï¼æ¬Šé™è¨­å®šæ­£ç¢ºã€‚");
                        // æ¸…ç†æ¸¬è©¦è³‡æ–™
                        // window.dbRemove(testRef); 
                    } catch (e) {
                        log(`âŒ å¯«å…¥æ¸¬è©¦å¤±æ•—: ${e.code}`);
                        log(`è©³ç´°éŒ¯èª¤: ${e.message}`);
                        if (e.code === 'PERMISSION_DENIED') {
                            alert("æ¬Šé™ä¸è¶³ï¼è«‹å» Firebase Console æŠŠ Rules æ”¹æˆ trueã€‚");
                        } else {
                            alert(`é€£ç·šéŒ¯èª¤: ${e.message}\nè«‹æª¢æŸ¥ databaseURL æ˜¯å¦æ­£ç¢ºã€‚`);
                        }
                    }
                };

                // æ–°å¢è³‡æ–™ç›¸é—œ
                const addToPreview = () => {
                    if (!form.name) return alert("è«‹è¼¸å…¥å§“å");
                    previewList.value.push({ ...form, pattern: [...form.pattern] });
                    form.name = '';
                    form.order++;
                    log("å·²åŠ å…¥é è¦½æ¸…å–®");
                };

                const confirmRealUpload = async () => {
                    if (previewList.value.length === 0) return;
                    log(`æº–å‚™ä¸Šå‚³ ${previewList.value.length} ç­†è³‡æ–™...`);
                    
                    const updates = {};
                    previewList.value.forEach(item => {
                        // ä½¿ç”¨ cust_001 æ ¼å¼ç•¶ Key
                        const key = `cust_${item.order.toString().padStart(3, '0')}`;
                        updates[`customers/${key}`] = item;
                    });

                    try {
                        await window.dbUpdate(window.dbRef(window.db), updates);
                        log("âœ… æ‰¹é‡å¯«å…¥æˆåŠŸï¼");
                        previewList.value = [];
                    } catch (e) {
                        log(`âŒ æ‰¹é‡å¯«å…¥å¤±æ•—: ${e.message}`);
                        alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message);
                    }
                };

                const deleteItem = async (key) => {
                    if (!confirm(`ç¢ºå®šåˆªé™¤ ID: ${key} å—ï¼Ÿ`)) return;
                    try {
                        await window.dbRemove(window.dbRef(window.db, `customers/${key}`));
                        log(`ğŸ—‘ï¸ å·²åˆªé™¤ ${key}`);
                    } catch (e) {
                        log(`âŒ åˆªé™¤å¤±æ•—: ${e.message}`);
                    }
                };

                const customersList = computed(() => {
                    return Object.entries(customers.value).map(([key, val]) => ({
                        id: key,
                        ...val
                    })).sort((a, b) => a.order - b.order);
                });

                const reloadPage = () => location.reload();

                return {
                    view, connectionStatus, lastPing, debugLogs, form, previewList,
                    customersList, loading, connectionStatusText,
                    forceTestWrite, addToPreview, confirmRealUpload, deleteItem, reloadPage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>