<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç³»çµ± v5.0 - æ ¸å°åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLnhjqSEdXWn-HD0rg6liHcygj4-9FcIQ",
  authDomain: "crm-ts-1225-002.firebaseapp.com",
  projectId: "crm-ts-1225-002",
  storageBucket: "crm-ts-1225-002.firebasestorage.app",
  messagingSenderId: "855566092078",
  appId: "1:855566092078:web:064e295a48082a291a9cbf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;
        window.dbRef = ref;
        window.dbUpdate = update;
        window.dbOnValue = onValue;
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        
        <nav class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸš›</span> é…é€ä¸­æ§å° v5.0
            </h1>
            <div class="flex gap-2 text-sm">
                <button @click="currentView='manager'" :class="currentView==='manager'?'bg-blue-600':'bg-slate-700'" class="px-4 py-2 rounded transition">ç¶“ç†å¾Œå°</button>
                <button @click="currentView='delivery'" :class="currentView==='delivery'?'bg-emerald-600':'bg-slate-700'" class="px-4 py-2 rounded transition">é…é€å“¡</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-8 max-w-7xl mx-auto w-full">

            <div v-if="currentView === 'manager'" class="space-y-8">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-3 text-slate-700">æ­¥é©Ÿä¸€ï¼šä¾†æºè¨­å®š</h2>
                    <div class="flex gap-3">
                        <input type="text" v-model="sheetUrl" 
                               placeholder="è²¼ä¸Š Google Sheets ç™¼ä½ˆçš„ CSV é€£çµ..."
                               class="flex-grow p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <button @click="previewSheet" :disabled="loading" 
                                class="bg-blue-600 text-white px-6 rounded-lg hover:bg-blue-700 disabled:bg-slate-300 transition shadow flex items-center gap-2">
                            <span v-if="loading" class="animate-spin">ğŸ”„</span>
                            {{ loading ? 'è®€å–ä¸­' : 'è§£æä¸¦é è¦½' }}
                        </button>
                    </div>
                </div>

                <div v-if="previewItems.length > 0" class="bg-amber-50 border-2 border-amber-300 rounded-xl overflow-hidden shadow-lg animate-fade-in">
                    <div class="p-4 bg-amber-100 border-b border-amber-200 flex justify-between items-center">
                        <div>
                            <h2 class="font-bold text-amber-800 text-lg flex items-center gap-2">
                                <span>ğŸ‘€</span> æ­¥é©ŸäºŒï¼šé è¦½èˆ‡æ ¸å° ({{ previewItems.length }} ç­†)
                            </h2>
                            <p class="text-xs text-amber-700 mt-1">è«‹å‹¾é¸ç¢ºèªç„¡èª¤çš„è³‡æ–™ï¼ŒæŒ‰ä¸‹å„²å­˜å¾Œæ‰æœƒå¯«å…¥ç³»çµ±ã€‚</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="clearPreview" class="text-slate-500 hover:text-slate-700 text-sm underline">å–æ¶ˆ / æ¸…ç©º</button>
                            <button @click="confirmUpload" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700 shadow font-bold flex items-center gap-2">
                                <span>ğŸ’¾</span> ç¢ºèªå¯«å…¥ Firebase
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-h-[400px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-amber-100 text-amber-800 sticky top-0 z-10 font-bold">
                                <tr>
                                    <th class="p-3 text-center w-12">
                                        <input type="checkbox" v-model="selectAll" @change="toggleSelectAll" class="w-4 h-4 cursor-pointer">
                                    </th>
                                    <th class="p-3">æ¬¡åº</th>
                                    <th class="p-3">åç¨±</th>
                                    <th class="p-3">å€åŸŸ</th>
                                    <th class="p-3">é€±ä¸€ç¸½é‡</th>
                                    <th class="p-3">é€±äºŒç¸½é‡</th>
                                    <th class="p-3">è³‡æ–™ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-amber-200">
                                <tr v-for="item in previewItems" :key="item.tempId" class="hover:bg-amber-100/50 transition">
                                    <td class="p-3 text-center">
                                        <input type="checkbox" :value="item.tempId" v-model="selectedPreviewIds" class="w-4 h-4 cursor-pointer accent-amber-600">
                                    </td>
                                    <td class="p-3 font-mono">{{ item.order }}</td>
                                    <td class="p-3 font-bold">{{ item.name }}</td>
                                    <td class="p-3">{{ item.area }}</td>
                                    <td class="p-3"><span class="bg-white px-2 py-0.5 rounded border border-amber-200">{{ getDaySum(item.pattern, 0) }}</span></td>
                                    <td class="p-3"><span class="bg-white px-2 py-0.5 rounded border border-amber-200">{{ getDaySum(item.pattern, 1) }}</span></td>
                                    <td class="p-3 text-xs text-green-600 font-bold">
                                        è§£ææˆåŠŸ ({{ item.pattern.reduce((a,b)=>a+b,0) }}ç“¶)
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-700">ğŸŸ¢ æ­¥é©Ÿä¸‰ï¼šç·šä¸Šé‹ä½œä¸­çš„è³‡æ–™ ({{ sortedCustomers.length }} ç­†)</h2>
                        <button @click="generateDailyLogs" class="bg-slate-600 text-white px-4 py-1.5 rounded text-xs hover:bg-slate-700">
                             ç”¢ç”Ÿ 12æœˆ/1æœˆ æ¯æ—¥å ±è¡¨
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-500 sticky top-0">
                                <tr>
                                    <th class="p-3">åº</th>
                                    <th class="p-3">åç¨±</th>
                                    <th class="p-3">å€åŸŸ</th>
                                    <th v-for="d in weekDays" :key="d" class="p-3 text-center bg-slate-50">{{d}}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="cust in sortedCustomers" :key="cust.id" class="hover:bg-slate-50">
                                    <td class="p-3 font-mono text-slate-400">{{ cust.order }}</td>
                                    <td class="p-3 font-bold text-slate-700">{{ cust.name }}</td>
                                    <td class="p-3 text-slate-500">{{ cust.area }}</td>
                                    <td v-for="i in 7" :key="i" class="p-3 text-center border-l border-slate-100">
                                        <span v-if="getDaySum(cust.pattern, i-1) > 0" class="text-blue-600 font-bold bg-blue-50 px-2 rounded-full text-xs">
                                            {{ getDaySum(cust.pattern, i-1) }}
                                        </span>
                                        <span v-else class="text-slate-200">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="space-y-4 max-w-md mx-auto">
                <div class="sticky top-20 z-40 bg-white/95 backdrop-blur shadow-md rounded-2xl p-4 flex justify-between items-center border border-slate-200">
                    <button @click="changeDate(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full">â—€</button>
                    <div class="text-center">
                        <div class="text-xs text-blue-500 font-bold">{{ getWeekDayName(selectedDate) }}</div>
                        <div class="font-bold text-xl text-slate-800">{{ selectedDate.substring(5) }}</div>
                    </div>
                    <button @click="changeDate(1)" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full">â–¶</button>
                </div>
                <div v-if="sortedDailyList.length > 0" class="pb-20 space-y-3">
                    <div v-for="item in sortedDailyList" :key="item.id" class="bg-white rounded-xl shadow-sm border p-4 transition-all relative overflow-hidden" :class="item.status==='delivered'?'border-green-200 opacity-60':''">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="item.status==='delivered'?'bg-green-500':'bg-blue-500'"></div>
                        <div class="pl-2 flex gap-3">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2"><span class="bg-slate-800 text-white text-xs px-1.5 rounded">{{ item.order }}</span><span class="font-bold text-lg">{{ item.name }}</span></div>
                                <div class="text-xs text-slate-500 mb-2">{{ item.area }}</div>
                                <div class="flex flex-wrap gap-1 mb-2">
                                    <template v-for="(q, t) in item.items"><span v-if="q>0" class="px-2 py-0.5 rounded text-xs border" :class="flavorStyle(t)">{{flavorName(t)}}{{q}}</span></template>
                                </div>
                                <input v-model.lazy="item.note" @change="updateNote(item)" placeholder="å‚™è¨»..." class="w-full text-sm bg-slate-50 border-b p-1 outline-none">
                            </div>
                            <button @click="toggleStatus(item)" class="w-12 h-12 rounded-full border-2 flex items-center justify-center text-xl shrink-0" :class="item.status==='delivered'?'bg-green-500 border-green-500 text-white':'bg-white border-slate-200 text-slate-200'">{{ item.status==='delivered'?'âœ“':'â—‹' }}</button>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-12 text-slate-400">æœ¬æ—¥ç„¡ä»»å‹™</div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentView = ref('manager');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const sheetUrl = ref('');
                const loading = ref(false);
                const customers = ref({});
                const dailyData = ref({});
                
                // --- æ–°å¢ï¼šé è¦½ç›¸é—œè®Šæ•¸ ---
                const previewItems = ref([]); // æš«å­˜è§£æå¾Œçš„è³‡æ–™
                const selectedPreviewIds = ref([]); // ä½¿ç”¨è€…å‹¾é¸çš„ tempId
                const selectAll = ref(true);

                // Firebase ç›£è½
                onMounted(() => {
                    window.dbOnValue(window.dbRef(window.db, 'customers'), s => customers.value = s.val() || {});
                    loadDailyData(selectedDate.value);
                });

                // å·¥å…·ï¼šæ•¸å­—å…¨å½¢è½‰åŠå½¢
                const normalizeNum = (val) => {
                    if (!val) return 0;
                    const str = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
                    const num = parseInt(str);
                    return isNaN(num) ? 0 : num;
                };

                // --- æ­¥é©Ÿ1: è®€å–ä¸¦é è¦½ (ä¸å¯«å…¥) ---
                async function previewSheet() {
                    if(!sheetUrl.value) return alert("è«‹è¼¸å…¥ç¶²å€");
                    loading.value = true;
                    previewItems.value = []; 
                    
                    try {
                        const res = await fetch(sheetUrl.value);
                        const text = await res.text();
                        const rows = text.split('\n');
                        
                        const tempResult = [];
                        rows.forEach((row, index) => {
                            const cols = row.split(',').map(c => c.trim());
                            // åˆ¤æ–·æ¬¡åº(Col 1)æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
                            const order = normalizeNum(cols[1]);
                            
                            if (order > 0 && cols.length >= 39) {
                                // å»ºç«‹æš«å­˜ç‰©ä»¶
                                const pattern = [];
                                for(let i=4; i<=38; i++) pattern.push(normalizeNum(cols[i]));

                                tempResult.push({
                                    tempId: `temp_${order}`, // æš«æ™‚ ID ä¾›å‰ç«¯å‹¾é¸ç”¨
                                    dbId: `cust_${order.toString().padStart(3,'0')}`, // çœŸå¯¦ DB ID
                                    cycle: cols[0],
                                    order: order,
                                    name: cols[2],
                                    area: cols[3],
                                    pattern: pattern
                                });
                            }
                        });

                        previewItems.value = tempResult;
                        // é è¨­å…¨é¸
                        selectedPreviewIds.value = tempResult.map(i => i.tempId);
                        selectAll.value = true;
                        
                        if(tempResult.length === 0) alert("æœªè§£æåˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼ã€‚");

                    } catch(e) {
                        alert("è®€å–å¤±æ•—ï¼š" + e.message);
                    }
                    loading.value = false;
                }

                // --- æ­¥é©Ÿ2: å…¨é¸/åé¸é‚è¼¯ ---
                function toggleSelectAll() {
                    if (selectAll.value) {
                        selectedPreviewIds.value = previewItems.value.map(i => i.tempId);
                    } else {
                        selectedPreviewIds.value = [];
                    }
                }

                // --- æ­¥é©Ÿ3: ç¢ºèªä¸¦å¯«å…¥ Firebase ---
                async function confirmUpload() {
                    const selectedCount = selectedPreviewIds.value.length;
                    if(selectedCount === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€ç­†è³‡æ–™");
                    if(!confirm(`ç¢ºå®šè¦å°‡é€™ ${selectedCount} ç­†è³‡æ–™å¯«å…¥ç³»çµ±å—ï¼Ÿ`)) return;

                    loading.value = true;
                    const updates = {};
                    
                    // æ‰¾å‡ºè¢«å‹¾é¸çš„é …ç›®
                    const itemsToUpload = previewItems.value.filter(item => selectedPreviewIds.value.includes(item.tempId));
                    
                    itemsToUpload.forEach(item => {
                        updates[`customers/${item.dbId}`] = {
                            cycle: item.cycle,
                            order: item.order,
                            name: item.name,
                            area: item.area,
                            pattern: item.pattern
                        };
                    });

                    try {
                        await window.dbUpdate(window.dbRef(window.db), updates);
                        alert("âœ… æ›´æ–°æˆåŠŸï¼å…¶ä»–å·¥ä½œè€…å°‡å³æ™‚æ”¶åˆ°è³‡æ–™ã€‚");
                        clearPreview(); // æˆåŠŸå¾Œæ¸…ç©ºé è¦½å€
                    } catch(e) {
                        alert("å¯«å…¥å¤±æ•—ï¼š" + e.message);
                    }
                    loading.value = false;
                }

                function clearPreview() {
                    previewItems.value = [];
                    selectedPreviewIds.value = [];
                }

                // --- ä¸‹æ–¹ï¼šç”Ÿæˆå ±è¡¨é‚è¼¯ (ç¶­æŒä¸è®Š) ---
                async function generateDailyLogs() {
                    if(!confirm("ç¢ºå®šæ›´æ–°é…é€å ±è¡¨ï¼Ÿ")) return;
                    // ... (æ­¤è™•é‚è¼¯åŒå‰ç‰ˆï¼Œçœç•¥é‡è¤‡è§£é‡‹)
                    const updates = {};
                    const start = new Date("2025-12-01");
                    const end = new Date("2026-01-31");
                    Object.entries(customers.value).forEach(([id, c]) => {
                         for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            const dStr = d.toISOString().split('T')[0];
                            let pIdx = d.getDay()===0?6:d.getDay()-1;
                            const items = {
                                original: c.pattern[pIdx*5]||0, sweet: c.pattern[pIdx*5+1]||0,
                                choco: c.pattern[pIdx*5+2]||0, strawberry: c.pattern[pIdx*5+3]||0, brown: c.pattern[pIdx*5+4]||0
                            };
                            if(Object.values(items).reduce((a,b)=>a+b,0)>0) {
                                updates[`daily_operations/${dStr}/${id}`] = {
                                    name:c.name, order:c.order, area:c.area, items, status:'pending', note:''
                                };
                            }
                         }
                    });
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    alert("å ±è¡¨ç”Ÿæˆå®Œç•¢");
                }

                // --- é…é€å“¡é‚è¼¯ (ç¶­æŒä¸è®Š) ---
                function loadDailyData(d) {
                    window.dbOnValue(window.dbRef(window.db, `daily_operations/${d}`), s => dailyData.value = s.val() || {});
                }
                const changeDate = (n) => {
                    const d = new Date(selectedDate.value); d.setDate(d.getDate()+n);
                    selectedDate.value = d.toISOString().split('T')[0]; loadDailyData(selectedDate.value);
                }
                const toggleStatus = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {status: i.status==='delivered'?'pending':'delivered'});
                const updateNote = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {note: i.note});

                // UI Helpers
                const sortedCustomers = computed(() => Object.entries(customers.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const sortedDailyList = computed(() => Object.entries(dailyData.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const getDaySum = (p,i) => p?p.slice(i*5,i*5+5).reduce((a,b)=>a+b,0):0;
                const weekDays = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
                const getWeekDayName = (d) => weekDays[new Date(d).getDay()];
                const flavorName = (k)=>({original:'åŸ',sweet:'ç”œ',choco:'å·§',strawberry:'è“',brown:'é»‘'}[k]);
                const flavorStyle = (k)=>({original:'bg-blue-50 text-blue-700 border-blue-200',sweet:'bg-pink-50 text-pink-700 border-pink-200',choco:'bg-amber-50 text-amber-800 border-amber-200',strawberry:'bg-red-50 text-red-700 border-red-200',brown:'bg-yellow-50 text-yellow-800 border-yellow-200'}[k]);

                return {
                    currentView, selectedDate, sheetUrl, loading, weekDays,
                    customers, sortedCustomers, dailyData, sortedDailyList,
                    // Preview
                    previewItems, selectedPreviewIds, selectAll, previewSheet, toggleSelectAll, confirmUpload, clearPreview,
                    // Logic
                    generateDailyLogs, changeDate, toggleStatus, updateNote, getDaySum, getWeekDayName, flavorName, flavorStyle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>