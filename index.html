<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç³»çµ± v7.0 - å®‰å…¨é©—è­‰ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // æ›´æ–°ç‚º 003 æ†‘è­‰
        const firebaseConfig = {
            apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
            authDomain: "crm-1225-003.firebaseapp.com",
            projectId: "crm-1225-003",
            storageBucket: "crm-1225-003.firebasestorage.app",
            messagingSenderId: "566985177794",
            appId: "1:566985177794:web:fcf21c033bd62c3bd7195b",
            databaseURL: "https://crm-1225-003-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.dbRef = ref;
        window.dbUpdate = update;
        window.dbOnValue = onValue;
        window.dbSet = set;
    </script>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="min-h-screen flex flex-col">
        
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
                <div class="text-4xl mb-4">ğŸ”</div>
                <h2 class="text-xl font-bold mb-6">ç®¡ç†å“¡é©—è­‰</h2>
                <input type="password" v-model="loginPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                       class="w-full p-4 bg-slate-100 rounded-2xl mb-4 text-center outline-none focus:ring-2 focus:ring-indigo-500">
                <button @click="checkLogin" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition">
                    ç™»å…¥ç³»çµ±
                </button>
                <p v-if="loginError" class="text-rose-500 text-xs mt-4">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥</p>
            </div>
        </div>

        <nav class="bg-white border-b p-4 sticky top-0 z-50 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">TS</div>
                <h1 class="font-black text-slate-800">é…é€ç³»çµ± <span class="text-[10px] text-slate-400">003-v7</span></h1>
            </div>
            <div class="flex bg-slate-100 p-1 rounded-2xl">
                <button @click="currentView='manager'" :class="currentView==='manager'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-4 py-1.5 rounded-xl text-xs font-bold transition">ç¶“ç†</button>
                <button @click="currentView='delivery'" :class="currentView==='delivery'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-4 py-1.5 rounded-xl text-xs font-bold transition">é…é€å“¡</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-8 max-w-5xl mx-auto w-full">
            
            <div v-if="sysLog" class="mb-6 p-4 rounded-2xl text-xs font-mono" :class="sysLog.type==='err'?'bg-rose-50 text-rose-600 border border-rose-200':'bg-emerald-50 text-emerald-600 border border-emerald-200'">
                [{{ sysLog.time }}] {{ sysLog.msg }}
                <button @click="sysLog=null" class="float-right font-bold">é—œé–‰</button>
            </div>

            <div v-if="currentView === 'manager'" class="space-y-6">
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold">å¿«é€ŸéŒ„å…¥èˆ‡é€£ç·šæ¸¬è©¦</h2>
                        <button @click="testDB" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full font-bold">æ¸¬è©¦é€£ç·š</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <button v-for="(demo, idx) in demoData" @click="loadDemo(demo)" class="p-2 border rounded-xl text-[10px] hover:bg-slate-50">ç¯„æœ¬: {{demo.name}}</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <input v-model.number="form.order" type="number" placeholder="é †åº" class="p-3 bg-slate-50 rounded-xl text-sm border">
                        <input v-model="form.name" type="text" placeholder="å§“å" class="p-3 bg-slate-50 rounded-xl text-sm border">
                        <select v-model="form.area" class="p-3 bg-slate-50 rounded-xl text-sm border">
                            <option value="å¤§åŸ”">å¤§åŸ”</option><option value="ä¸‰å³½">ä¸‰å³½</option><option value="é¶¯æ­Œ">é¶¯æ­Œ</option>
                        </select>
                        <select v-model="form.cycle" class="p-3 bg-slate-50 rounded-xl text-sm border">
                            <option value="æ¯å¤©">æ¯å¤©</option><option value="è‡¨æ™‚">è‡¨æ™‚</option>
                        </select>
                    </div>
                    <button @click="addToPreview" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition active:scale-95">
                        â• åŠ å…¥é è¦½æ¸…å–®
                    </button>
                </div>

                <div v-if="previews.length > 0" class="bg-amber-50 rounded-3xl p-6 border-2 border-amber-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-black text-amber-900">å¾…ç¢ºèªä¸Šå‚³ ({{previews.length}})</h2>
                        <button @click="uploadToFirebase" :disabled="loading" class="bg-amber-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-amber-700 shadow-xl disabled:bg-slate-300">
                            {{ loading ? 'åŒæ­¥ä¸­...' : 'ğŸ’¾ ç¢ºèªåŒæ­¥è‡³é›²ç«¯' }}
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto space-y-2">
                        <div v-for="p in previews" class="flex justify-between bg-white/60 p-2 rounded-lg text-xs">
                            <span>#{{p.order}} {{p.name}}</span>
                            <span class="font-bold text-amber-600">ç­‰å¾…å¯«å…¥...</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 bg-slate-50 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700">é›²ç«¯å³æ™‚çœ‹æ¿</h2>
                        <button @click="generateReports" class="text-[10px] bg-slate-800 text-white px-3 py-1 rounded-full">æ›´æ–°æœˆå ±è¡¨</button>
                    </div>
                    <table class="w-full text-xs text-left">
                        <thead class="bg-white border-b">
                            <tr><th class="p-4">åº</th><th class="p-4">å§“å</th><th class="p-4 text-center" v-for="d in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']">{{d}}</th></tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="c in sortedCustomers" class="hover:bg-indigo-50/30 transition">
                                <td class="p-4 text-slate-400">{{c.order}}</td>
                                <td class="p-4 font-bold">{{c.name}}</td>
                                <td v-for="i in 7" class="p-4 text-center">
                                    <span v-if="getDaySum(c.pattern, i-1) > 0" class="bg-indigo-600 text-white w-5 h-5 inline-flex items-center justify-center rounded-full text-[10px] font-bold">
                                        {{getDaySum(c.pattern, i-1)}}
                                    </span>
                                    <span v-else class="text-slate-100">-</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="max-w-md mx-auto space-y-4">
                <div class="bg-white shadow-xl rounded-[32px] p-6 border flex justify-between items-center sticky top-20 z-40">
                    <button @click="moveDate(-1)" class="w-12 h-12 bg-slate-50 rounded-2xl text-xl">â—€</button>
                    <div class="text-center">
                        <div class="text-indigo-600 font-bold text-xs">{{getWeekName(selectedDate)}}</div>
                        <div class="text-2xl font-black">{{selectedDate.substring(5)}}</div>
                    </div>
                    <button @click="moveDate(1)" class="w-12 h-12 bg-slate-50 rounded-2xl text-xl">â–¶</button>
                </div>
                <div v-for="item in sortedDailies" class="bg-white p-6 rounded-[28px] shadow-sm border flex justify-between items-center transition-all" :class="item.status==='done'?'opacity-40 scale-95':''">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-slate-900 text-white text-[10px] px-2 py-0.5 rounded-lg">{{item.order}}</span>
                            <span class="text-xl font-bold">{{item.name}}</span>
                        </div>
                        <div class="flex gap-1">
                            <template v-for="(q, t) in item.items"><span v-if="q>0" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md border border-indigo-100 font-bold">{{t.substring(0,1)}}:{{q}}</span></template>
                        </div>
                    </div>
                    <button @click="toggleStatus(item)" class="w-16 h-16 rounded-2xl border-4 text-3xl font-bold flex items-center justify-center" :class="item.status==='done'?'bg-emerald-500 border-emerald-100 text-white':'bg-white border-slate-50 text-slate-100'">
                        {{item.status==='done'?'âœ“':'â—‹'}}
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const isLoggedIn = ref(false);
                const loginPwd = ref('');
                const loginError = ref(false);
                const currentView = ref('manager');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const sysLog = ref(null);
                const loading = ref(false);
                const customers = ref({});
                const dailies = ref({});
                const previews = ref([]);
                const form = reactive({ order:1, name:'', area:'å¤§åŸ”', cycle:'æ¯å¤©', pattern: new Array(35).fill(0) });

                const demoData = [
                    { name: "é™³å¤§åŸ”", area: "å¤§åŸ”", cycle: "æ¯å¤©", pattern: [1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0] },
                    { name: "æ—é€±æœ«", area: "ä¸‰å³½", cycle: "æ¯å¤©", pattern: [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 2,2,0,0,0, 2,2,0,0,0] }
                ];

                const checkLogin = () => {
                    if(loginPwd.value === 'ts1225') { // é è¨­å¯†ç¢¼ ts1225
                        isLoggedIn.value = true;
                    } else {
                        loginError.value = true;
                    }
                };

                onMounted(() => {
                    if (window.dbOnValue) {
                        window.dbOnValue(window.dbRef(window.db, 'customers'), s => customers.value = s.val() || {});
                        loadDaily(selectedDate.value);
                    }
                });

                const log = (msg, type='info') => {
                    sysLog.value = { time: new Date().toLocaleTimeString(), msg, type };
                };

                const testDB = async () => {
                    try {
                        await window.dbSet(window.dbRef(window.db, 'connection_test'), Date.now());
                        log("âœ… é€£ç·šæ¸¬è©¦æˆåŠŸï¼æ¬Šé™å·²é–‹å•Ÿã€‚");
                    } catch (e) {
                        log("âŒ é€£ç·šå¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥ Firebase Rules æ˜¯å¦è¨­ç‚º trueã€‚", 'err');
                    }
                };

                const addToPreview = () => {
                    if(!form.name) return;
                    previews.value.push({ ...form, pattern: [...form.pattern] });
                    form.name = ''; form.order++;
                };

                const uploadToFirebase = async () => {
                    loading.value = true;
                    const updates = {};
                    previews.value.forEach(p => {
                        updates[`customers/cust_${p.order.toString().padStart(3,'0')}`] = { ...p };
                    });
                    try {
                        await window.dbUpdate(window.dbRef(window.db), updates);
                        log("âœ… æˆåŠŸåŒæ­¥è‡³ crm-1225-003ï¼");
                        previews.value = [];
                    } catch (e) {
                        log("âŒ å¯«å…¥å¤±æ•—ã€‚åŸå› ï¼š" + e.code, 'err');
                    }
                    loading.value = false;
                };

                const loadDemo = (d) => { Object.assign(form, d); form.order = Object.keys(customers.value).length + 1; };
                const sortedCustomers = computed(() => Object.entries(customers.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const getDaySum = (p,i) => p?p.slice(i*5,i*5+5).reduce((a,b)=>a+b,0):0;
                
                async function generateReports() {
                    const updates = {}; const start = new Date("2025-12-01"); const end = new Date("2026-01-31");
                    Object.entries(customers.value).forEach(([id, c]) => {
                        for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                            const dStr = d.toISOString().split('T')[0];
                            let pIdx = d.getDay()===0?6:d.getDay()-1;
                            const items = { åŸ: c.pattern[pIdx*5]||0, ç”œ: c.pattern[pIdx*5+1]||0, å·§: c.pattern[pIdx*5+2]||0, è“: c.pattern[pIdx*5+3]||0, é»‘: c.pattern[pIdx*5+4]||0 };
                            if(Object.values(items).reduce((a,b)=>a+b,0)>0) updates[`daily_operations/${dStr}/${id}`] = { name:c.name, order:c.order, area:c.area, items, status:'pending' };
                        }
                    });
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    log("âœ… 12æœˆ/1æœˆ é…é€å–®å·²æ›´æ–°æˆåŠŸï¼");
                }

                function loadDaily(d) { window.dbOnValue(window.dbRef(window.db, `daily_operations/${d}`), s => dailies.value = s.val() || {}); }
                const moveDate = (n) => { const d=new Date(selectedDate.value); d.setDate(d.getDate()+n); selectedDate.value=d.toISOString().split('T')[0]; loadDaily(selectedDate.value); }
                const toggleStatus = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {status: i.status==='done'?'pending':'done'});
                const sortedDailies = computed(() => Object.entries(dailies.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const getWeekName = (d) => ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()];

                return {
                    isLoggedIn, loginPwd, loginError, checkLogin, currentView, selectedDate, sysLog, loading, previews, form, demoData,
                    testDB, addToPreview, uploadToFirebase, loadDemo, sortedCustomers, getDaySum, generateReports, moveDate, toggleStatus, sortedDailies, getWeekName
                };
            }
        }).mount('#app');
    </script>
</body>
</html>