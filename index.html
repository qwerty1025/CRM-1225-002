<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶ä¸­æ§ç³»çµ± V16.2 (ERP å®Œæ•´ç‰ˆ)</title>
    <style>
        :root {
            --sidebar-width: 260px;
            --primary: #2c3e50;
            --accent: #8e44ad; /* ç´«è‰²ç³» */
            --bg: #f0f2f5;
            --border: #e0e0e0;
            --group-bg: #f3e5f5;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Hub Navigation (Top Bar) --- */
        .hub-nav {
            background: var(--primary); color: white; padding: 0 20px; height: 50px;
            display: flex; align-items: center; gap: 20px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .hub-title { font-weight: bold; font-size: 1.1rem; margin-right: 20px; letter-spacing: 1px; }
        .hub-btn {
            background: transparent; border: none; color: #b0bec5; padding: 0 15px; height: 50px;
            cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.2s; border-bottom: 3px solid transparent;
        }
        .hub-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .hub-btn.active { color: white; border-bottom: 3px solid var(--accent); background: rgba(0,0,0,0.2); }

        /* --- Layout Container --- */
        .app-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Views */
        .view-section { display: none; width: 100%; height: 100%; overflow: hidden; }
        .view-section.active { display: flex; }

        /* --- View A: Operations (V15 Layout) --- */
        .sidebar {
            width: var(--sidebar-width); background: white; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; z-index: 10;
        }
        .sidebar.collapsed { width: 50px; }
        
        .c-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .addr-header { background: var(--group-bg); color: #4a148c; padding: 4px 10px; font-size: 0.75rem; font-weight: bold; position: sticky; top: 0; border-bottom: 1px solid #e1bee7; }
        .c-item { padding: 8px 10px 8px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px dashed #f5f5f5; font-size: 0.8rem; }
        .c-item:hover { background: #f3e5f5; }
        .c-item.active { background: #e1bee7; border-left: 4px solid var(--accent); font-weight: bold; }
        .c-item.suspended { text-decoration: line-through; color: #999; background: #eee; }

        .workspace { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #fafafa; }
        
        /* Header & Inputs */
        .header-container { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input, select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .sector-select { background: #f3e5f5; color: #4a148c; font-weight: bold; }
        
        /* Billing Accordion */
        .billing-accordion { border: 1px solid #ddd; border-radius: 6px; overflow: hidden; background: white; margin-bottom: 5px; }
        .billing-summary { background: #f8f9fa; padding: 10px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .billing-content { padding: 15px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .bill-stat-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }

        /* Calendar Matrix */
        .cal-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .cal-card { background: white; border-radius: 6px; padding: 8px; border-top: 3px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 5px; }
        .cal-cell { aspect-ratio: 1; border: 1px solid #f5f5f5; position: relative; cursor: pointer; border-radius: 3px; font-size: 0.7rem; }
        .st-normal { background: #d1c4e9; }
        .st-holiday { background: #f5f5f5; }
        .st-paused { background: #ffcdd2; }
        .content-badge { position: absolute; bottom: 1px; right: 1px; left: 1px; background: rgba(255,255,255,0.9); font-size: 0.6rem; text-align: center; border: 1px solid #ddd; }
        .suspend-overlay { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.7); font-weight: bold; color: #c0392b; transform: rotate(-15deg); pointer-events: none; }

        /* --- View B: Finance --- */
        .finance-layout { padding: 20px; display: flex; gap: 20px; height: 100%; box-sizing: border-box; }
        .finance-panel { flex: 1; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { text-align: left; background: #f1f2f6; padding: 8px; position: sticky; top: 0; }
        .log-table td { border-bottom: 1px solid #eee; padding: 8px; }
        
        /* --- View C: Production --- */
        .prod-layout { padding: 20px; display: flex; flex-direction: column; gap: 20px; height: 100%; overflow-y: auto; box-sizing: border-box; }
        .harvest-controls { display: flex; gap: 15px; background: white; padding: 15px; border-radius: 8px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .prod-matrix { width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white; }
        .prod-matrix th, .prod-matrix td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        .prod-matrix th { background: #2c3e50; color: white; }
        .gap-pos { color: var(--success); font-weight: bold; }
        .gap-neg { color: var(--danger); font-weight: bold; }
        .flavor-detail { font-size: 0.75rem; color: #666; display: block; margin-top: 4px; line-height: 1.2; }

        /* --- View D: Settings --- */
        .settings-layout { padding: 20px; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .setting-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .prod-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        /* Buttons & Footer */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        
        .sb-footer { padding: 10px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 5px; background: #fff; margin-top: auto; }
        .btn-io { width: 100%; background: #ecf0f1; color: #555; font-size: 0.75rem; justify-content: center; }
        .btn-io:hover { background: #d0d3d4; }
        
        /* Float Button */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 100; }

        /* Import Modal */
        #loadingModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999; }
        .loading-box { background: white; padding: 20px; border-radius: 8px; text-align: center; width: 300px; }

    </style>
</head>
<body>

<nav class="hub-nav">
    <div class="hub-title">ğŸ ç¾Šå¥¶ä¸­æ§ V16.2</div>
    <button class="hub-btn active" onclick="switchView('ops')">ğŸ“¦ ç‡Ÿé‹èˆ‡é…é€</button>
    <button class="hub-btn" onclick="switchView('finance')">ğŸ’° è²¡å‹™èˆ‡æ—¥èªŒ</button>
    <button class="hub-btn" onclick="switchView('prod')">ğŸ¥› ç”¢èƒ½èˆ‡åº«å­˜</button>
    <button class="hub-btn" onclick="switchView('settings')">âš™ï¸ è¨­å®šèˆ‡ç”¢å“</button>
</nav>

<div class="app-container">

    <div id="view-ops" class="view-section active">
        <aside class="sidebar" id="sidebar">
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex;">
                <input type="text" id="searchInput" placeholder="æœå°‹å§“å/åœ°å€..." style="width:100%" oninput="filterList()">
            </div>
            <ul class="c-list" id="customerList">
                <li style="padding:15px; text-align:center; color:#999;">è¼‰å…¥ä¸­...</li>
            </ul>
            <div class="sb-footer">
                <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="resetForm(true)">+ æ–°å¢å®¢æˆ¶</button>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-io" onclick="document.getElementById('csvInput').click()">ğŸ“‚ åŒ¯å…¥</button>
                    <button class="btn btn-io" onclick="exportCSV()">ğŸ’¾ åŒ¯å‡º</button>
                </div>
                <input type="file" id="csvInput" accept=".csv" style="display:none">
            </div>
        </aside>
        
        <main class="workspace">
            <div id="emptyState" style="text-align:center; color:#999; margin-top:100px;">
                <h3>ğŸ‘‹ è«‹é¸æ“‡å·¦å´å®¢æˆ¶é€²è¡Œç·¨è¼¯</h3>
            </div>

            <div id="opsWorkspace" style="display:none; flex-direction:column; gap:15px;">
                <div class="header-container">
                    <div class="row">
                        <select id="inpSector" class="sector-select" style="width:100px"></select>
                        <input id="inpName" placeholder="å§“å" style="width:100px; font-weight:bold;">
                        <input id="inpPhone" placeholder="é›»è©±" style="width:120px;">
                        <input id="inpAddr" placeholder="åœ°å€" style="flex:1;">
                        <input id="inpPrice" type="number" placeholder="$" style="width:50px;" title="å–®åƒ¹">
                        <button class="btn btn-danger" onclick="deleteCustomer()">ğŸ—‘ï¸</button>
                    </div>
                    <div class="row" style="background:#f8f9fa; padding:8px; border-radius:4px;">
                        <span style="font-size:0.8rem; color:#666;">å‚™è¨»A:</span> <input id="inpNoteA" style="flex:1;">
                        <span style="font-size:0.8rem; color:#666;">å‚™è¨»B:</span> <input id="inpNoteB" style="flex:1;">
                        <label style="margin-left:10px; font-size:0.9rem; color:red; font-weight:bold;">
                            <input type="checkbox" id="chkSuspended"> æš«åœè¨‚è³¼
                        </label>
                    </div>
                </div>

                <details class="billing-accordion">
                    <summary class="billing-summary">
                        <span>ğŸ’³ å¸³å‹™èˆ‡æ”¶æ¬¾ç®¡ç†</span>
                        <span style="font-size:0.8rem; color:#666;">é»æ“Šå±•é–‹</span>
                    </summary>
                    <div class="billing-content">
                        <div class="row">
                            <input type="month" id="billMonth" onchange="calcBill()">
                            <button class="btn btn-warning" onclick="calcBill(true)">ğŸ”„ é‡æ–°è¨ˆç®—</button>
                        </div>
                        <div id="billResult">
                            <div class="bill-stat-row"><span>æ‡‰é€ç¸½ç“¶æ•¸:</span> <b id="b_qty">0</b></div>
                            <div class="bill-stat-row"><span>æ‡‰æ”¶é‡‘é¡:</span> <b id="b_amt" style="color:var(--accent)">$0</b></div>
                        </div>
                        <div class="row" style="border-top:1px dashed #ddd; padding-top:10px;">
                            <input type="number" id="payAmount" placeholder="æ”¶æ¬¾é‡‘é¡" style="width:100px;">
                            <input type="text" id="payNote" placeholder="å‚™è¨» (ä¾‹: ç¾é‡‘/è½‰å¸³)" style="flex:1;">
                            <button class="btn btn-success" onclick="addPayment()">âœ… ç¢ºèªæ”¶æ¬¾</button>
                        </div>
                        <div style="font-size:0.75rem; color:#999; margin-top:5px;">* æ”¶æ¬¾æ“ä½œå°‡å¯«å…¥ç³»çµ±æµæ°´å¸³</div>
                    </div>
                </details>

                <div class="header-container">
                    <div class="row" style="justify-content:space-between;">
                        <div id="patternBox" class="row"></div>
                        <label><input type="checkbox" id="chkHoliday"> è¦‹ç´…ä¸ä¼‘</label>
                    </div>
                    <table style="width:100%; border-collapse:collapse; text-align:center; font-size:0.85rem; margin-top:5px;">
                        <thead><tr style="background:#eee;"><th></th><th>åŸ</th><th>ç”œ</th><th>å·§</th><th>è‰</th><th>é»‘</th></tr></thead>
                        <tbody id="matrixBody"></tbody>
                    </table>
                </div>

                <div class="cal-wrapper" id="calendarGrid"></div>
                <div style="height:50px;"></div>
            </div>
            
            <div class="fab" id="fabSave" style="display:none;" onclick="saveData()">ğŸ’¾</div>
        </main>
    </div>

    <div id="view-finance" class="view-section">
        <div class="finance-layout">
            <div class="finance-panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>ğŸ’¸ è²¡å‹™æµæ°´å¸³ (ä¾ç™»å…¥æ™‚é–“)</h3>
                    <button class="btn btn-primary" onclick="loadFinanceLogs()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div style="flex:1; overflow-y:auto;">
                    <table class="log-table">
                        <thead><tr><th>æ™‚é–“</th><th>å®¢æˆ¶</th><th>æœˆä»½</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>ç¶“æ‰‹äºº</th></tr></thead>
                        <tbody id="financeLogBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="finance-panel">
                <h3>ğŸ›¡ï¸ ç³»çµ±æ“ä½œæ—¥èªŒ (å›æœ”)</h3>
                <div style="flex:1; overflow-y:auto; margin-top:10px;">
                    <ul id="auditLogList" style="list-style:none; padding:0; font-size:0.85rem; color:#555;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="view-prod" class="view-section">
        <div class="prod-layout">
            <div class="harvest-controls">
                <h3>ğŸŒ¾ æ¡æ”¶èˆ‡ä¾›éœ€æ¯”å°</h3>
                <input type="date" id="harvestDate">
                <input type="number" id="harvestWeight" placeholder="æ¡æ”¶å…¬æ–¤æ•¸ (kg)" style="width:120px;">
                <input type="text" id="harvestNote" placeholder="å‚™è¨» (ä¾‹:æ—©ç­)" style="width:150px;">
                <button class="btn btn-success" onclick="saveHarvest()">â• ç™»è¨˜æ¡æ”¶</button>
                <span style="flex:1;"></span>
                <button class="btn btn-accent" onclick="calcForecast()">ğŸ“Š è¨ˆç®—æœªä¾†å…©é€±é æ¸¬</button>
            </div>

            <div style="flex:1; overflow:auto;">
                <table class="prod-matrix">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>è¨‚å–®ç¸½ç“¶æ•¸ / æ˜ç´°</th>
                            <th>é ä¼°éœ€æ±‚ (kg)</th>
                            <th>å¯¦éš›æ¡æ”¶ (kg)</th>
                            <th>çµé¤˜ (Gap)</th>
                        </tr>
                    </thead>
                    <tbody id="forecastBody">
                        <tr><td colspan="5" style="padding:20px; color:#999;">è«‹é»æ“Šã€Œè¨ˆç®—æœªä¾†å…©é€±é æ¸¬ã€</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="font-size:0.8rem; color:#666; padding:0 20px;">* éœ€æ±‚é‡é‡ä¾æ“šã€Œè¨­å®šã€é é¢ä¸­çš„ç”¢å“å–®ç“¶é‡é‡è¨ˆç®—ã€‚</div>
        </div>
    </div>

    <div id="view-settings" class="view-section">
        <div class="settings-layout">
            <div class="setting-card">
                <h3>ğŸ¥› ç”¢å“é …ç›®èˆ‡é‡é‡è¨­å®š</h3>
                <div class="row" style="margin-bottom:10px;">
                    <input id="prodName" placeholder="ç”¢å“å (å¦‚:åŸå‘³)" style="width:120px;">
                    <input id="prodWeight" type="number" placeholder="å–®ç“¶é‡é‡(g)" style="width:100px;">
                    <input id="prodPrice" type="number" placeholder="é è¨­å–®åƒ¹" style="width:80px;">
                    <button class="btn btn-primary" onclick="addProduct()">æ–°å¢/æ›´æ–°</button>
                </div>
                <div id="productList"></div>
            </div>

            <div class="setting-card">
                <h3>ğŸ“… å…¨åŸŸæ—¥ç¨‹æ§ç®¡ (é¢±é¢¨/å‡æ—¥)</h3>
                <div class="row" style="margin-bottom:10px;">
                    <input type="date" id="globalDate">
                    <select id="globalType">
                        <option value="typhoon">ğŸŒªï¸ é¢±é¢¨/ç·Šæ€¥åœé€ (æ‰£æ¬¾)</option>
                        <option value="holiday">ğŸ”´ åœ‹å®šå‡æ—¥ (ä¾è¦‹ç´…ä¸ä¼‘)</option>
                    </select>
                    <button class="btn btn-danger" onclick="addGlobalEvent()">è¨­å®š</button>
                </div>
                <ul id="globalEventList" style="padding-left:20px; color:#555;"></ul>
            </div>
        </div>
    </div>

</div>

<div id="loadingModal">
    <div class="loading-box">
        <h3>è³‡æ–™è™•ç†ä¸­...</h3>
        <div style="width:100%; height:4px; background:#eee; margin-top:10px;"><div id="progressBar" style="width:0; height:100%; background:var(--accent);"></div></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs, setDoc, getDoc, serverTimestamp, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Configuration (Update for V16.2) ---
    const firebaseConfig = {
        apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
        authDomain: "crm-1225-003.firebaseapp.com",
        projectId: "crm-1225-003",
        storageBucket: "crm-1225-003.firebasestorage.app",
        messagingSenderId: "566985177794",
        appId: "1:566985177794:web:fcf21c033bd62c3bd7195b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collections
    const C_CUSTOMERS = "customers_v16"; 
    const C_PRODUCTS = "products_v16";
    const C_HARVEST = "harvests_v16";
    const C_FINANCE = "finance_logs_v16";
    const C_AUDIT = "audit_logs_v16";
    const C_GLOBAL = "global_settings_v16";

    // Constants
    const SECTORS = ["å¤§åŸ”", "äºŒé¬®", "æ·»ç¦", "ä¸­åœ’è¡—", "å¼˜é“", "è€è¡—", "é•·æ³°è¡—", "ä»‹å£½è·¯", "æ°¸å®‰è¡—", "å…‰æ˜è·¯", "å¤§åŒè·¯", "ä¸­è¯è·¯", "ä¸­æ­£è·¯", "èœå¸‚å ´", "ä¸­å±±è·¯", "å¤§ä»è·¯", "å¾©èˆˆè·¯", "åŒ—å¤§", "é¶¯æ­Œ", "å…¶ä»–"];
    const FLAVORS = ["åŸå‘³", "ç”œå‘³", "å·§å…‹åŠ›", "è‰è“", "é»‘ç³–"];
    const DAYS = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

    // State
    let customersData = [];
    let productsMap = {}; 
    let globalEvents = {}; 
    let currentId = null;
    let currentMatrix = {};
    let manualOverrides = {};

    // --- Initialization ---
    window.onload = async () => {
        initHub();
        initUI();
        await loadSettings();
        subscribeCustomers();
    };

    function initHub() {
        window.switchView = (viewId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.hub-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.querySelector(`button[onclick="switchView('${viewId}')"]`).classList.add('active');
            
            if(viewId === 'finance') loadFinanceLogs();
            if(viewId === 'settings') renderProductList();
        };
    }

    function initUI() {
        const sel = document.getElementById('inpSector');
        SECTORS.forEach(s => { const o = document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
        
        const tb = document.getElementById('matrixBody');
        [1,2,3,4,5,6,0].forEach(d => {
            let html = `<td style="font-weight:bold; color:${d===0||d===6?'red':'#333'}">${DAYS[d]}</td>`;
            FLAVORS.forEach(f => {
                const key = `${d}_${f}`;
                const opts = (f==="åŸå‘³")?[1,2,4,6]:[1,2];
                let btns = opts.map(v => `<span class="c-item" style="display:inline-block; padding:2px 6px; border:1px solid #ddd; margin:1px; border-radius:3px;" data-key="${key}" data-val="${v}" onclick="toggleMx(this)">${v}</span>`).join('');
                html += `<td>${btns}</td>`;
            });
            const tr = document.createElement('tr'); tr.innerHTML = html; tb.appendChild(tr);
        });

        const ptBox = document.getElementById('patternBox');
        [{l:"å¹³æ—¥",d:[1,2,3,4,5]}, {l:"æ¯å¤©",d:[0,1,2,3,4,5,6]}, {l:"ä¸€ä¸‰äº”",d:[1,3,5]}].forEach(p => {
            const b = document.createElement('button'); b.textContent=p.l; b.className='btn btn-primary'; b.style.marginRight='5px';
            b.onclick = () => {
                document.querySelectorAll('span[data-key]').forEach(e=>e.style.background='white');
                currentMatrix={};
                p.d.forEach(d => {
                    const k=`${d}_åŸå‘³`; currentMatrix[k]=1;
                    const el = document.querySelector(`span[data-key="${k}"][data-val="1"]`);
                    if(el) { el.style.background='#8e44ad'; el.style.color='white'; }
                });
                renderCal();
            };
            ptBox.appendChild(b);
        });
        document.getElementById('billMonth').value = new Date().toISOString().slice(0,7);
        
        // Import Logic (Restored V15)
        document.getElementById('csvInput').addEventListener('change', importCSV);
    }

    // --- Core Data Logic ---
    async function loadSettings() {
        onSnapshot(collection(db, C_PRODUCTS), (snap) => {
            snap.forEach(d => { productsMap[d.data().name] = d.data(); });
            renderProductList();
        });
        onSnapshot(doc(db, C_GLOBAL, "calendar"), (docSnap) => {
            if(docSnap.exists()) {
                globalEvents = docSnap.data();
                renderGlobalList();
                if(currentId) renderCal();
            }
        });
    }

    function subscribeCustomers() {
        onSnapshot(query(collection(db, C_CUSTOMERS), orderBy("updatedAt", "desc")), (snap) => {
            customersData = [];
            snap.forEach(d => customersData.push({id: d.id, data: d.data()}));
            filterList();
        });
    }

    window.toggleMx = (el) => {
        const k = el.dataset.key; const v = parseInt(el.dataset.val);
        const active = el.style.background === 'rgb(142, 68, 173)';
        document.querySelectorAll(`span[data-key="${k}"]`).forEach(e=>{e.style.background='white'; e.style.color='#333';});
        if(active) delete currentMatrix[k];
        else { currentMatrix[k] = v; el.style.background='#8e44ad'; el.style.color='white'; }
        renderCal();
    };

    // --- Operations View Functions ---
    window.filterList = () => {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const list = document.getElementById('customerList');
        list.innerHTML = '';
        
        const filtered = customersData.filter(c => 
            c.data.name.includes(key) || (c.data.phone||'').includes(key) || (c.data.address||'').includes(key)
        );

        filtered.sort((a,b) => {
            let ia = SECTORS.indexOf(a.data.sector||"å…¶ä»–");
            let ib = SECTORS.indexOf(b.data.sector||"å…¶ä»–");
            return (ia===-1?99:ia) - (ib===-1?99:ib);
        });

        let lastSec = "";
        filtered.forEach(c => {
            const sec = c.data.sector || "å…¶ä»–";
            if(sec !== lastSec) {
                const h = document.createElement('div'); h.className='addr-header'; h.textContent=`ğŸ™ï¸ ${sec}`;
                list.appendChild(h); lastSec = sec;
            }
            const li = document.createElement('li');
            li.className = `c-item ${c.data.isSuspended?'suspended':''} ${c.id===currentId?'active':''}`;
            li.innerHTML = `<span>${c.data.name}</span><span style="color:#999;font-size:0.75rem">${c.data.phone||''}</span>`;
            li.onclick = () => loadCustomer(c);
            list.appendChild(li);
        });
    };

    window.resetForm = (isNew) => {
        currentId = null;
        document.getElementById('emptyState').style.display = isNew ? 'none' : 'block';
        document.getElementById('opsWorkspace').style.display = isNew ? 'flex' : 'none';
        document.getElementById('fabSave').style.display = isNew ? 'flex' : 'none';
        
        document.querySelectorAll('input').forEach(i => { if(i.type!=='checkbox' && i.type!=='date' && i.type!=='month' && i.type!=='file') i.value=''; });
        document.getElementById('inpSector').value = "å…¶ä»–";
        document.getElementById('inpPrice').value = 35;
        document.getElementById('chkSuspended').checked = false;
        document.getElementById('chkHoliday').checked = false;
        
        currentMatrix = {}; manualOverrides = {};
        document.querySelectorAll('span[data-key]').forEach(e=>{e.style.background='white';e.style.color='#333'});
        if(isNew) renderCal();
    };

    function loadCustomer(cObj) {
        resetForm(false);
        currentId = cObj.id;
        const d = cObj.data;
        
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('opsWorkspace').style.display = 'flex';
        document.getElementById('fabSave').style.display = 'flex';

        document.getElementById('inpName').value = d.name;
        document.getElementById('inpPhone').value = d.phone||'';
        document.getElementById('inpAddr').value = d.address||'';
        document.getElementById('inpSector').value = d.sector||'å…¶ä»–';
        document.getElementById('inpPrice').value = d.unitPrice||35;
        document.getElementById('inpNoteA').value = d.noteA||'';
        document.getElementById('inpNoteB').value = d.noteB||'';
        document.getElementById('chkSuspended').checked = d.isSuspended||false;
        document.getElementById('chkHoliday').checked = d.holidayDeliver||false;

        currentMatrix = d.matrix || {};
        manualOverrides = d.manualOverrides || {};

        Object.keys(currentMatrix).forEach(k => {
            const el = document.querySelector(`span[data-key="${k}"][data-val="${currentMatrix[k]}"]`);
            if(el) { el.style.background='#8e44ad'; el.style.color='white'; }
        });
        renderCal();
        calcBill();
    }

    window.saveData = async () => {
        const name = document.getElementById('inpName').value;
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        
        const data = {
            name,
            phone: document.getElementById('inpPhone').value,
            address: document.getElementById('inpAddr').value,
            sector: document.getElementById('inpSector').value,
            unitPrice: parseInt(document.getElementById('inpPrice').value)||35,
            noteA: document.getElementById('inpNoteA').value,
            noteB: document.getElementById('inpNoteB').value,
            isSuspended: document.getElementById('chkSuspended').checked,
            holidayDeliver: document.getElementById('chkHoliday').checked,
            matrix: currentMatrix,
            manualOverrides: manualOverrides,
            updatedAt: serverTimestamp()
        };

        if(currentId) {
            await updateDoc(doc(db, C_CUSTOMERS, currentId), data);
            addLog("update_customer", name, "æ›´æ–°åŸºæœ¬è³‡æ–™");
        } else {
            await addDoc(collection(db, C_CUSTOMERS), data);
            addLog("create_customer", name, "å»ºç«‹æ–°å®¢æˆ¶");
        }
        alert("âœ… å„²å­˜æˆåŠŸ");
    };

    window.deleteCustomer = async () => {
        if(!currentId || !confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        await deleteDoc(doc(db, C_CUSTOMERS, currentId));
        addLog("delete_customer", document.getElementById('inpName').value, "æ°¸ä¹…åˆªé™¤");
        resetForm(false);
    };

    // --- CSV Import/Export (Restored from V15) ---
    window.exportCSV = () => {
        if(customersData.length === 0) return alert("ç„¡è³‡æ–™");
        let csv = "\uFEFFå§“å,é›»è©±,è¡—å€,åœ°å€,å‚™è¨»A,å‚™è¨»B,æš«åœè¨‚è³¼,å–®åƒ¹,è¦‹ç´…ä¸ä¼‘,é€±æ—¥,é€±ä¸€,é€±äºŒ,é€±ä¸‰,é€±å››,é€±äº”,é€±å…­\n";
        
        customersData.forEach(item => {
            const c = item.data;
            const daysData = [];
            for(let d=0; d<7; d++) {
                let parts = [];
                FLAVORS.forEach(f => {
                    const k = `${d}_${f}`;
                    if(c.matrix && c.matrix[k]>0) parts.push(`${f}${c.matrix[k]}`);
                });
                daysData.push(parts.join(";"));
            }
            const row = [
                c.name, c.phone||"", c.sector||"å…¶ä»–", c.address||"", c.noteA||"", c.noteB||"",
                c.isSuspended?"TRUE":"FALSE", c.unitPrice||35, c.holidayDeliver?"TRUE":"FALSE", ...daysData
            ];
            csv += row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",") + "\n";
        });
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
        link.download = `V16_2_Export_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    };

    async function importCSV(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        document.getElementById('loadingModal').style.display = 'flex';
        
        reader.onload = async (evt) => {
            const text = evt.target.result;
            const rows = text.split(/\r?\n/);
            const headers = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const idx = {
                name: headers.indexOf("å§“å"), phone: headers.indexOf("é›»è©±"), addr: headers.indexOf("åœ°å€"),
                sector: headers.indexOf("è¡—å€"), noteA: headers.indexOf("å‚™è¨»A"), noteB: headers.indexOf("å‚™è¨»B"),
                susp: headers.indexOf("æš«åœè¨‚è³¼"), price: headers.indexOf("å–®åƒ¹"), hol: headers.indexOf("è¦‹ç´…ä¸ä¼‘"),
                days: [headers.indexOf("é€±æ—¥"), headers.indexOf("é€±ä¸€"), headers.indexOf("é€±äºŒ"), headers.indexOf("é€±ä¸‰"), headers.indexOf("é€±å››"), headers.indexOf("é€±äº”"), headers.indexOf("é€±å…­")]
            };

            if(idx.name === -1) { alert("CSV æ ¼å¼éŒ¯èª¤: ç¼ºå°‘å§“å"); document.getElementById('loadingModal').style.display='none'; return; }
            
            let count = 0;
            const batchSize = 400; // Firestore batch limit is 500
            let batch = writeBatch(db);
            
            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                // Simple CSV split handling quotes
                const cols = rows[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                
                // Need to map cleanCols index back to original header index? 
                // Actually the regex split might not align perfectly if empty columns exist.
                // Robust approach: split by comma but respect quotes.
                // Re-using specific logic from V15 for safety:
                const rowArr = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
                
                const matrix = {};
                idx.days.forEach((colIdx, dayIdx) => {
                    if(colIdx > -1 && rowArr[colIdx]) {
                        rowArr[colIdx].split(/[,;]/).forEach(item => {
                            const match = item.match(/([\u4e00-\u9fa5]+)(\d+)/);
                            if(match) matrix[`${dayIdx}_${match[1]}`] = parseInt(match[2]);
                        });
                    }
                });

                const docRef = doc(collection(db, C_CUSTOMERS));
                batch.set(docRef, {
                    name: rowArr[idx.name],
                    phone: idx.phone>-1 ? rowArr[idx.phone] : "",
                    address: idx.addr>-1 ? rowArr[idx.addr] : "",
                    sector: idx.sector>-1 ? (rowArr[idx.sector]||"å…¶ä»–") : "å…¶ä»–",
                    noteA: idx.noteA>-1 ? rowArr[idx.noteA] : "",
                    noteB: idx.noteB>-1 ? rowArr[idx.noteB] : "",
                    isSuspended: idx.susp>-1 ? (rowArr[idx.susp]==="TRUE") : false,
                    unitPrice: idx.price>-1 ? (parseInt(rowArr[idx.price])||35) : 35,
                    holidayDeliver: idx.hol>-1 ? (rowArr[idx.hol]==="TRUE") : false,
                    matrix: matrix, manualOverrides: {}, updatedAt: serverTimestamp()
                });

                count++;
                if(count % batchSize === 0) { await batch.commit(); batch = writeBatch(db); }
                document.getElementById('progressBar').style.width = Math.min(100, Math.round((i / rows.length)*100)) + "%";
            }
            await batch.commit();
            
            document.getElementById('loadingModal').style.display = 'none';
            alert(`åŒ¯å…¥å®Œæˆ: ${count} ç­†`);
            e.target.value = '';
        };
        reader.readAsText(file);
    }

    // --- Calendar & Bill Logic ---
    function renderCal() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        
        for(let i=0; i<2; i++) {
            const viewD = new Date(start.getFullYear(), start.getMonth()+i, 1);
            const y = viewD.getFullYear(); const m = viewD.getMonth();
            const dim = new Date(y, m+1, 0).getDate();
            const fd = new Date(y, m, 1).getDay();

            let cells = '';
            for(let k=0; k<fd; k++) cells += `<div></div>`;

            let mTotal = 0;
            for(let d=1; d<=dim; d++) {
                const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const dw = new Date(y,m,d).getDay();
                
                const globalType = globalEvents[dateStr];
                const override = manualOverrides[dateStr];
                const suspended = document.getElementById('chkSuspended').checked;
                const holDeliver = document.getElementById('chkHoliday').checked;
                const isSun = (dw===0);
                
                let bQty = 0; let txt = "";
                FLAVORS.forEach(f => {
                    const q = currentMatrix[`${dw}_${f}`] || 0;
                    if(q>0) { bQty+=q; txt+=(f[0]+q); }
                });

                let state = 'st-normal'; let finalQty = bQty; let overlay = "";
                if(bQty===0) state = 'st-none';

                if (globalType === 'typhoon') { state = 'st-paused'; finalQty = 0; overlay = "é¢±é¢¨"; }
                else if (override === 1) { state = 'st-paused'; finalQty = 0; overlay = "åœ"; }
                else if (suspended) { state = 'st-paused'; finalQty = 0; overlay = "æš«åœ"; }
                else if ((isSun || globalType === 'holiday') && !holDeliver) { state = 'st-holiday'; finalQty = 0; }
                
                mTotal += finalQty;
                cells += `<div class="cal-cell ${state}" onclick="cycleDate('${dateStr}')"><span style="position:absolute;top:1px;left:2px;font-weight:bold;">${d}</span>${finalQty>0 ? `<div class="content-badge">${txt}</div>` : ''}${overlay ? `<div class="suspend-overlay">${overlay}</div>` : ''}</div>`;
            }

            const card = document.createElement('div');
            card.className='cal-card';
            card.innerHTML = `<div style="font-weight:bold;margin-bottom:5px;">${y}/${m+1} (é ä¼°: ${mTotal}ç“¶)</div><div class="cal-grid">${cells}</div>`;
            grid.appendChild(card);
        }
    }

    window.cycleDate = (dateStr) => {
        if(!currentId) return;
        const old = manualOverrides[dateStr] || 0;
        manualOverrides[dateStr] = (old === 0) ? 1 : 0;
        if(manualOverrides[dateStr] === 0) delete manualOverrides[dateStr];
        renderCal();
    };

    window.calcBill = async (isManualRecalc = false) => {
        if(!currentId) return;
        const mStr = document.getElementById('billMonth').value;
        const [y, m] = mStr.split('-').map(Number);
        const dim = new Date(y, m, 0).getDate();
        
        let totalBottles = 0;
        for(let d=1; d<=dim; d++) {
            const dateStr = `${y}-${m.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const dw = new Date(y, m-1, d).getDay();
            
            const globalType = globalEvents[dateStr];
            const override = manualOverrides[dateStr];
            const suspended = document.getElementById('chkSuspended').checked;
            const holDeliver = document.getElementById('chkHoliday').checked;
            const isSun = (dw===0);

            let dailyQ = 0;
            FLAVORS.forEach(f => dailyQ += (currentMatrix[`${dw}_${f}`]||0));

            if (globalType === 'typhoon' || override === 1 || suspended) dailyQ = 0;
            else if ((isSun || globalType === 'holiday') && !holDeliver) dailyQ = 0;
            
            totalBottles += dailyQ;
        }

        const basePrice = parseInt(document.getElementById('inpPrice').value) || 35;
        const totalAmt = totalBottles * basePrice;

        document.getElementById('b_qty').textContent = totalBottles;
        document.getElementById('b_amt').textContent = `$${totalAmt}`;

        if(isManualRecalc) {
            await addLog("recalc_bill", document.getElementById('inpName').value, `é‡æ–°è¨ˆç®—${mStr}å¸³å–®: ${totalAmt}å…ƒ`);
            alert("å·²é‡æ–°è¨ˆç®—ä¸¦è¨˜éŒ„æ—¥èªŒ");
        }
    };

    window.addPayment = async () => {
        const amt = document.getElementById('payAmount').value;
        const note = document.getElementById('payNote').value;
        if(!amt) return alert("è«‹è¼¸å…¥é‡‘é¡");
        
        await addDoc(collection(db, C_FINANCE), {
            customerId: currentId,
            customerName: document.getElementById('inpName').value,
            month: document.getElementById('billMonth').value,
            amount: parseInt(amt),
            note: note,
            timestamp: serverTimestamp()
        });
        await addLog("collect_money", document.getElementById('inpName').value, `æ”¶æ¬¾ $${amt} (${note})`);
        document.getElementById('payAmount').value = '';
        document.getElementById('payNote').value = '';
        alert("âœ… æ”¶æ¬¾å·²è¨˜éŒ„");
    };

    // --- Finance & Logs ---
    window.loadFinanceLogs = () => {
        const tbody = document.getElementById('financeLogBody');
        tbody.innerHTML = '<tr><td colspan="6">è¼‰å…¥ä¸­...</td></tr>';
        onSnapshot(query(collection(db, C_FINANCE), orderBy("timestamp", "desc"), limit(50)), (snap) => {
            tbody.innerHTML = '';
            snap.forEach(d => {
                const r = d.data();
                const ts = r.timestamp ? r.timestamp.toDate().toLocaleString() : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${ts}</td><td>${r.customerName}</td><td>${r.month}</td><td style="color:green;font-weight:bold;">$${r.amount}</td><td>${r.note}</td><td>Admin</td>`;
                tbody.appendChild(tr);
            });
        });
        const ul = document.getElementById('auditLogList');
        onSnapshot(query(collection(db, C_AUDIT), orderBy("timestamp", "desc"), limit(50)), (snap) => {
            ul.innerHTML = '';
            snap.forEach(d => {
                const r = d.data();
                const ts = r.timestamp ? r.timestamp.toDate().toLocaleString() : '-';
                const li = document.createElement('li');
                li.style.borderBottom='1px solid #eee'; li.style.padding='5px';
                li.innerHTML = `<b>[${ts}]</b> ${r.action} @ ${r.target} - ${r.detail}`;
                ul.appendChild(li);
            });
        });
    };

    // --- Production & Forecast (Updated V16.2: Breakdown) ---
    window.saveHarvest = async () => {
        const d = document.getElementById('harvestDate').value;
        const w = document.getElementById('harvestWeight').value;
        if(!d || !w) return alert("è³‡æ–™ä¸å…¨");
        await addDoc(collection(db, C_HARVEST), { date: d, weight: parseFloat(w), note: document.getElementById('harvestNote').value, timestamp: serverTimestamp() });
        addLog("add_harvest", "æ¡æ”¶è¨˜éŒ„", `${d}: ${w}kg`);
        alert("ç™»è¨˜æˆåŠŸ");
    };

    window.calcForecast = async () => {
        document.getElementById('loadingModal').style.display = 'flex';
        const tbody = document.getElementById('forecastBody');
        tbody.innerHTML = '';
        
        const days = [];
        const today = new Date();
        for(let i=0; i<14; i++) {
            const d = new Date(today); d.setDate(today.getDate()+i);
            days.push(d.toISOString().split('T')[0]);
        }

        const harvestMap = {};
        const hSnap = await getDocs(query(collection(db, C_HARVEST), orderBy("date", "desc"), limit(30)));
        hSnap.forEach(d => { harvestMap[d.data().date] = d.data().weight; });

        let forecastMap = {}; // date -> {bottles, kg, flavors:{}}
        const weightMap = {}; 
        FLAVORS.forEach(f => weightMap[f] = (productsMap[f]?.weight || 936)/1000 );

        customersData.forEach(cObj => {
            const c = cObj.data;
            if(c.isSuspended) return;

            days.forEach(dateStr => {
                const dateObj = new Date(dateStr);
                const dw = dateObj.getDay();
                
                const globalType = globalEvents[dateStr];
                const override = (c.manualOverrides||{})[dateStr];
                const isHol = (dw===0 || globalType==='holiday');

                if(globalType === 'typhoon' || override === 1) return;
                if(isHol && !c.holidayDeliver) return;

                if(!forecastMap[dateStr]) forecastMap[dateStr] = {bottles:0, kg:0, flavors:{}};
                
                FLAVORS.forEach(f => {
                    const q = (c.matrix||{})[`${dw}_${f}`] || 0;
                    if(q>0) {
                        forecastMap[dateStr].bottles += q;
                        forecastMap[dateStr].kg += (q * weightMap[f]);
                        forecastMap[dateStr].flavors[f] = (forecastMap[dateStr].flavors[f]||0) + q;
                    }
                });
            });
        });

        days.forEach(dateStr => {
            const data = forecastMap[dateStr] || {bottles:0, kg:0, flavors:{}};
            const act = harvestMap[dateStr] || 0;
            const gap = act - data.kg;
            
            // Generate Flavor Detail String
            let flavorStr = "";
            FLAVORS.forEach(f => {
                if(data.flavors[f] > 0) flavorStr += `${f[0]}${data.flavors[f]} `;
            });

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td>
                    <b>${data.bottles}</b>
                    <span class="flavor-detail">${flavorStr}</span>
                </td>
                <td>${data.kg.toFixed(1)}</td>
                <td>${act > 0 ? act : '-'}</td>
                <td class="${gap>=0?'gap-pos':'gap-neg'}">${act>0 ? gap.toFixed(1) : '?'}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('loadingModal').style.display = 'none';
    };

    // --- Settings ---
    window.renderProductList = () => {
        const div = document.getElementById('productList');
        div.innerHTML = '';
        Object.values(productsMap).forEach(p => {
            const item = document.createElement('div');
            item.className = 'prod-list-item';
            item.innerHTML = `<span><b>${p.name}</b> (${p.weight}g) $${p.price}</span> <button class="btn btn-danger" style="font-size:0.7rem">X</button>`;
            div.appendChild(item);
        });
    };

    window.addProduct = async () => {
        const name = document.getElementById('prodName').value;
        const w = document.getElementById('prodWeight').value;
        const p = document.getElementById('prodPrice').value;
        if(!name) return;
        await addDoc(collection(db, C_PRODUCTS), { name, weight: parseInt(w), price: parseInt(p) });
        addLog("setting_change", "ç”¢å“", `æ›´æ–° ${name}: ${w}g / $${p}`);
    };

    window.addGlobalEvent = async () => {
        const d = document.getElementById('globalDate').value;
        const t = document.getElementById('globalType').value;
        if(!d) return;
        globalEvents[d] = t;
        await setDoc(doc(db, C_GLOBAL, "calendar"), globalEvents);
        renderGlobalList();
        addLog("setting_change", "å…¨åŸŸæ—¥ç¨‹", `è¨­å®š ${d} ç‚º ${t}`);
    };

    function renderGlobalList() {
        const ul = document.getElementById('globalEventList');
        ul.innerHTML = '';
        Object.keys(globalEvents).sort().forEach(d => {
            const li = document.createElement('li');
            li.textContent = `${d}: ${globalEvents[d] === 'typhoon' ? 'ğŸŒªï¸ é¢±é¢¨åœé€' : 'ğŸ”´ åœ‹å®šå‡æ—¥'}`;
            ul.appendChild(li);
        });
    }

    async function addLog(action, target, detail) {
        await addDoc(collection(db, C_AUDIT), { action, target, detail, timestamp: serverTimestamp() });
    }

</script>
</body>
</html>