<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç®¡ç† v7.5 - å³æ™‚ç·¨è¼¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // æ›´æ–°å¾Œçš„ 003 å°ˆæ¡ˆæ†‘è­‰
        const firebaseConfig = {
            apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
            authDomain: "crm-1225-003.firebaseapp.com",
            projectId: "crm-1225-003",
            storageBucket: "crm-1225-003.firebasestorage.app",
            messagingSenderId: "566985177794",
            appId: "1:566985177794:web:fcf21c033bd62c3bd7195b",
            databaseURL: "https://crm-1225-003-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.dbRef = ref;
        window.dbUpdate = update;
        window.dbOnValue = onValue;
        window.dbSet = set;
        window.dbRemove = remove;
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col relative">
        
        <nav class="bg-white border-b p-4 sticky top-0 z-50 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-indigo-100">TS</div>
                <h1 class="font-black text-slate-800 text-lg">é…é€ç®¡ç†ä¸­æ§ <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-400">003-v7.5</span></h1>
            </div>
            <div class="flex bg-slate-100 p-1 rounded-2xl">
                <button @click="currentView='manager'" :class="currentView==='manager'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-5 py-2 rounded-xl text-xs font-bold transition">ç¶“ç†æ§åˆ¶å°</button>
                <button @click="currentView='delivery'" :class="currentView==='delivery'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-5 py-2 rounded-xl text-xs font-bold transition">é…é€æ¨¡å¼</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-8 max-w-6xl mx-auto w-full">
            
            <div v-if="currentView === 'manager'" class="space-y-6">
                
                <div class="bg-indigo-900 rounded-3xl p-5 text-white shadow-xl flex justify-between items-center animate__animated animate__fadeIn">
                    <div>
                        <h3 class="font-bold text-sm">Firebase 003 é€£ç·šç‹€æ…‹</h3>
                        <p class="text-[10px] text-indigo-300">è‹¥è¡¨æ ¼ç„¡è³‡æ–™ï¼Œè«‹é»æ“Šæ¸¬è©¦æŒ‰éˆ•æª¢æŸ¥æ¬Šé™</p>
                    </div>
                    <button @click="testConnection" class="bg-indigo-500 hover:bg-indigo-400 text-white px-6 py-2 rounded-xl text-xs font-bold transition shadow-lg">
                        æ¸¬è©¦å¯«å…¥æ¬Šé™
                    </button>
                </div>

                <div class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-black text-slate-700">{{ isEditingOnline ? 'âœï¸ æ­£åœ¨ä¿®æ”¹é›²ç«¯è³‡æ–™' : 'â• æ–°å¢é…é€å®¢æˆ¶' }}</h2>
                        <div v-if="isEditingOnline" @click="cancelEditOnline" class="text-rose-500 text-xs font-bold cursor-pointer underline">å–æ¶ˆç·¨è¼¯</div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 ml-1">é…é€é †åº (Order)</label>
                            <input v-model.number="manualForm.order" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-400 outline-none transition">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 ml-1">å®¢æˆ¶åç¨±</label>
                            <input v-model="manualForm.name" type="text" placeholder="è¼¸å…¥åç¨±" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-400 outline-none transition">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 ml-1">å€åŸŸ (ä¸‹æ‹‰)</label>
                            <select v-model="manualForm.area" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-400 outline-none transition">
                                <option value="å¤§åŸ”">å¤§åŸ”</option><option value="ä¸‰å³½">ä¸‰å³½</option><option value="é¶¯æ­Œ">é¶¯æ­Œ</option><option value="è‡¨æ™‚">è‡¨æ™‚é»</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 ml-1">é€±æœŸ</label>
                            <select v-model="manualForm.cycle" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-400 outline-none transition">
                                <option value="æ¯å¤©">æ¯å¤©</option><option value="å·¥ä½œæ—¥">å·¥ä½œæ—¥</option><option value="é€±æœ«">é€±æœ«</option><option value="è‡¨æ™‚å–®">è‡¨æ™‚å–®</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto border border-slate-100 rounded-2xl bg-slate-50/50 mb-6">
                        <table class="w-full text-[10px] text-center">
                            <thead class="bg-slate-100 text-slate-500 uppercase">
                                <tr><th class="p-2">é€±</th><th>åŸ</th><th>ç”œ</th><th>å·§</th><th>è“</th><th>é»‘</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="(day, dIdx) in weekDays" :key="dIdx" class="border-b border-slate-100/50">
                                    <td class="p-2 font-bold text-slate-400">{{day}}</td>
                                    <td v-for="fIdx in 5" :key="fIdx" class="p-1">
                                        <input v-model.number="manualForm.pattern[dIdx*5 + (fIdx-1)]" type="number" min="0" 
                                               class="w-8 h-8 p-0 text-center bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <button @click="addManualToPreview" :class="isEditingOnline ? 'bg-emerald-600 shadow-emerald-100' : 'bg-indigo-600 shadow-indigo-100'" 
                            class="w-full text-white py-4 rounded-2xl font-black shadow-xl hover:opacity-90 transition active:scale-95 flex items-center justify-center gap-2">
                        <span>{{ isEditingOnline ? 'ğŸ’¾ å„²å­˜é›²ç«¯è®Šæ›´' : 'â• åŠ å…¥é è¦½æ ¸å°æ¸…å–®' }}</span>
                    </button>
                </div>

                <div v-if="previewItems.length > 0" class="bg-amber-50 rounded-[32px] p-6 border-2 border-amber-300 shadow-lg animate__animated animate__fadeInUp">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-black text-amber-900 flex items-center gap-2"><span>ğŸ“¢</span> æº–å‚™åŒæ­¥è‡³ Firebase ({{previewItems.length}} ç­†)</h2>
                        <div class="flex gap-2">
                            <button @click="clearPreview" class="text-slate-400 text-xs font-bold px-4">æ¸…ç©º</button>
                            <button @click="confirmUpload" class="bg-amber-600 text-white px-8 py-3 rounded-2xl font-bold shadow-xl hover:bg-amber-700">ç¢ºèªä¸Šå‚³</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div v-for="item in previewItems" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-amber-200 text-xs">
                            <span class="font-bold">#{{item.order}} {{item.name}} ({{item.area}})</span>
                            <span class="text-amber-600 font-mono">é€±ç¸½é‡: {{item.pattern.reduce((a,b)=>a+b,0)}}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-[32px] shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">ğŸŒ é›²ç«¯è³‡æ–™å³æ™‚çœ‹æ¿ <span class="bg-emerald-500 w-2 h-2 rounded-full animate-pulse"></span></h2>
                        <button @click="generateDailyLogs" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-black">æ›´æ–° 12/1æœˆ å ±è¡¨</button>
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-[11px] text-left">
                            <thead class="bg-white sticky top-0 shadow-sm text-slate-400 font-black">
                                <tr>
                                    <th class="p-4">åº</th><th class="p-4">å§“å / å€åŸŸ</th>
                                    <th v-for="d in weekDays" :key="d" class="p-4 text-center">{{d}}</th>
                                    <th class="p-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="cust in sortedCustomers" :key="cust.id" class="hover:bg-indigo-50/40 transition group">
                                    <td class="p-4 font-mono text-slate-300">{{cust.order}}</td>
                                    <td class="p-4">
                                        <div class="font-bold text-slate-800">{{cust.name}}</div>
                                        <div class="text-[9px] text-slate-400">{{cust.area}} Â· {{cust.cycle}}</div>
                                    </td>
                                    <td v-for="i in 7" :key="i" class="p-4 text-center border-l border-slate-50/50">
                                        <span v-if="getDaySum(cust.pattern, i-1) > 0" class="bg-indigo-600 text-white w-5 h-5 inline-flex items-center justify-center rounded-full text-[10px] font-bold shadow-lg shadow-indigo-100">
                                            {{getDaySum(cust.pattern, i-1)}}
                                        </span>
                                        <span v-else class="text-slate-100">-</span>
                                    </td>
                                    <td class="p-4 text-center">
                                        <div class="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition">
                                            <button @click="editOnlineCustomer(cust)" class="text-indigo-600 font-bold px-2 py-1 rounded bg-indigo-50 hover:bg-indigo-100">ç·¨è¼¯</button>
                                            <button @click="deleteOnlineCustomer(cust.id)" class="text-rose-500 font-bold px-2 py-1 rounded bg-rose-50 hover:bg-rose-100">åˆªé™¤</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="max-w-md mx-auto space-y-4">
                <div class="bg-white shadow-2xl rounded-[32px] p-6 flex justify-between items-center sticky top-20 z-40">
                    <button @click="changeDate(-1)" class="w-12 h-12 bg-slate-50 rounded-2xl">â—€</button>
                    <div class="text-center">
                        <div class="text-indigo-600 font-black text-[10px] tracking-widest mb-1">{{getWeekDayName(selectedDate)}}</div>
                        <div class="text-2xl font-black text-slate-800">{{selectedDate.substring(5)}}</div>
                    </div>
                    <button @click="changeDate(1)" class="w-12 h-12 bg-slate-50 rounded-2xl">â–¶</button>
                </div>
                <div v-for="item in sortedDailyList" :key="item.id" class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-100 relative transition-all" :class="item.status==='delivered'?'opacity-30 grayscale':''">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-slate-900 text-white text-[10px] px-2 py-0.5 rounded-lg">{{item.order}}</span>
                                <h3 class="font-black text-xl">{{item.name}}</h3>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-3">
                                <template v-for="(q, t) in item.items"><span v-if="q>0" class="px-2 py-1 rounded-xl text-[10px] font-black border" :class="flavorStyle(t)">{{flavorName(t)}} {{q}}</span></template>
                            </div>
                            <input v-model.lazy="item.note" @change="updateNote(item)" placeholder="è¼¸å…¥é…é€æ¶ˆæ¯..." class="w-full text-[11px] bg-slate-50 p-2 rounded-xl outline-none">
                        </div>
                        <button @click="toggleStatus(item)" class="w-16 h-16 rounded-2xl border-4 flex items-center justify-center text-3xl" :class="item.status==='delivered'?'bg-emerald-500 border-emerald-100 text-white shadow-lg shadow-emerald-200':'bg-white border-slate-50 text-slate-100'">
                            {{item.status==='delivered'?'âœ“':'â—‹'}}
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <div v-if="showLog" class="fixed bottom-0 left-0 right-0 bg-black text-emerald-400 p-4 font-mono text-[10px] h-40 overflow-y-auto z-[60] border-t border-emerald-900">
            <div class="flex justify-between mb-2"><span class="font-bold text-white">SYSTEM LOGS</span><button @click="showLog=false">[CLOSE]</button></div>
            <div v-for="log in logs" class="mb-1">[{{log.time}}] {{log.msg}}</div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const currentView = ref('manager');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const showLog = ref(false);
                const logs = ref([]);
                const customers = ref({});
                const dailyData = ref({});
                const previewItems = ref([]);
                const weekDays = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
                
                // ç·¨è¼¯ç‹€æ…‹æ¨™è¨˜
                const isEditingOnline = ref(false);
                const editingOnlineId = ref(null);

                const manualForm = reactive({
                    order: 1, name: '', area: 'å¤§åŸ”', cycle: 'æ¯å¤©',
                    pattern: new Array(35).fill(0)
                });

                onMounted(() => {
                    window.dbOnValue(window.dbRef(window.db, 'customers'), (s) => {
                        customers.value = s.val() || {};
                        manualForm.order = Object.keys(customers.value).length + 1;
                    });
                    loadDailyData(selectedDate.value);
                });

                const addLog = (msg) => {
                    logs.value.push({ time: new Date().toLocaleTimeString(), msg });
                    showLog.value = true;
                };

                const testConnection = async () => {
                    try {
                        await window.dbSet(window.dbRef(window.db, 'connection_test'), Date.now());
                        addLog("âœ… Firebase é€£ç·šèˆ‡è®€å¯«æ¬Šé™æ¸¬è©¦æˆåŠŸï¼");
                    } catch (e) {
                        addLog(`âŒ å¤±æ•—: ${e.code}ã€‚è«‹æª¢æŸ¥ Firebase Rules è¦å‰‡ã€‚`);
                    }
                };

                // åŠ å…¥é è¦½æˆ–ç›´æ¥æ›´æ–°é›²ç«¯
                const addManualToPreview = async () => {
                    if(!manualForm.name) return;

                    if(isEditingOnline.value) {
                        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œç›´æ¥æ›´æ–°è³‡æ–™åº«
                        const dbId = editingOnlineId.value;
                        await window.dbUpdate(window.dbRef(window.db, `customers/${dbId}`), {
                            ...manualForm, pattern: [...manualForm.pattern]
                        });
                        addLog(`âœ… å·²æ›´æ–°é›²ç«¯è³‡æ–™: ${manualForm.name}`);
                        cancelEditOnline();
                    } else {
                        // ä¸€èˆ¬æ¨¡å¼ï¼ŒåŠ å…¥é è¦½
                        previewItems.value.push({
                            ...manualForm, pattern: [...manualForm.pattern], tempId: Date.now()
                        });
                        manualForm.name = '';
                        manualForm.order++;
                    }
                };

                const confirmUpload = async () => {
                    const updates = {};
                    previewItems.value.forEach(p => {
                        const id = `cust_${p.order.toString().padStart(3,'0')}`;
                        updates[`customers/${id}`] = { ...p };
                    });
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    addLog("âœ… è³‡æ–™å·²åŒæ­¥è‡³ Firebase 003ï¼");
                    previewItems.value = [];
                };

                // --- ç·¨è¼¯èˆ‡åˆªé™¤ç·šä¸Šè³‡æ–™ ---
                const editOnlineCustomer = (cust) => {
                    isEditingOnline.value = true;
                    editingOnlineId.value = cust.id;
                    Object.assign(manualForm, cust);
                    manualForm.pattern = [...cust.pattern];
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    addLog(`âœï¸ æ­£åœ¨ç·¨è¼¯: ${cust.name}`);
                };

                const cancelEditOnline = () => {
                    isEditingOnline.value = false;
                    editingOnlineId.value = null;
                    manualForm.name = '';
                    manualForm.order = Object.keys(customers.value).length + 1;
                    manualForm.pattern = new Array(35).fill(0);
                };

                const deleteOnlineCustomer = async (id) => {
                    if(confirm("ç¢ºå®šè¦å¾é›²ç«¯æ°¸ä¹…åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿ")) {
                        await window.dbRemove(window.dbRef(window.db, `customers/${id}`));
                        addLog(`ğŸ—‘ï¸ å·²åˆªé™¤å®¢æˆ¶è³‡æ–™: ${id}`);
                    }
                };

                // å ±è¡¨ã€çµ±è¨ˆå·¥å…·
                const getDaySum = (p,i) => p?p.slice(i*5,i*5+5).reduce((a,b)=>a+b,0):0;
                const sortedCustomers = computed(() => Object.entries(customers.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                
                async function generateDailyLogs() {
                    const updates = {}; const start = new Date("2025-12-01"); const end = new Date("2026-01-31");
                    Object.entries(customers.value).forEach(([id, c]) => {
                        for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                            const dStr = d.toISOString().split('T')[0];
                            let pIdx = d.getDay()===0?6:d.getDay()-1;
                            const items = { åŸ: c.pattern[pIdx*5]||0, ç”œ: c.pattern[pIdx*5+1]||0, å·§: c.pattern[pIdx*5+2]||0, è“: c.pattern[pIdx*5+3]||0, é»‘: c.pattern[pIdx*5+4]||0 };
                            if(Object.values(items).reduce((a,b)=>a+b,0)>0) updates[`daily_operations/${dStr}/${id}`] = { name:c.name, order:c.order, area:c.area, items, status:'pending', note:'' };
                        }
                    });
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    addLog("âœ… 12æœˆèˆ‡1æœˆé…é€å–®å·²é‡æ–°ç”Ÿæˆï¼");
                }

                function loadDailyData(d) { window.dbOnValue(window.dbRef(window.db, `daily_operations/${d}`), s => dailyData.value = s.val() || {}); }
                const changeDate = (n) => { const d=new Date(selectedDate.value); d.setDate(d.getDate()+n); selectedDate.value=d.toISOString().split('T')[0]; loadDailyData(selectedDate.value); }
                const toggleStatus = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {status: i.status==='delivered'?'pending':'delivered'});
                const updateNote = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {note: i.note});
                
                const sortedDailyList = computed(() => Object.entries(dailyData.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const getWeekDayName = (d) => ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()];
                const flavorName = (k)=>({åŸ:'åŸ',ç”œ:'ç”œ',å·§:'å·§',è“:'è“',é»‘:'é»‘'}[k]);
                const flavorStyle = (k)=>({åŸ:'bg-blue-50 text-blue-700',ç”œ:'bg-pink-50 text-pink-700',å·§:'bg-amber-50 text-amber-800',è“:'bg-red-50 text-red-700',é»‘:'bg-yellow-50 text-yellow-800'}[k]);

                return {
                    currentView, selectedDate, showLog, logs, sortedCustomers, previewItems, manualForm, weekDays, isEditingOnline,
                    testConnection, addManualToPreview, confirmUpload, editOnlineCustomer, cancelEditOnline, deleteOnlineCustomer,
                    getDaySum, generateDailyLogs, changeDate, toggleStatus, updateNote, sortedDailyList, getWeekDayName, flavorName, flavorStyle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>