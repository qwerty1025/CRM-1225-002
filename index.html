<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase é›²ç«¯è¨˜å¸³æœ¬</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { text-align: center; color: #333; }
        
        /* è¡¨å–®æ¨£å¼ */
        .input-group { margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button#submitBtn { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button#submitBtn:hover { background-color: #218838; }
        button#cancelBtn { width: 100%; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; display: none; }

        /* åˆ—è¡¨æ¨£å¼ */
        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #fff; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        li:last-child { border-bottom: none; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; font-size: 1.1em; }
        .item-date { font-size: 0.8em; color: #888; }
        .actions button { margin-left: 5px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .edit-btn { background-color: #ffc107; color: #333; }
        .delete-btn { background-color: #dc3545; color: white; }
        
        /* æç¤ºè¨Šæ¯ */
        #statusMsg { text-align: center; margin-top: 10px; height: 20px; font-size: 0.9em; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’° é›²ç«¯è¨˜å¸³æœ¬</h2>
    
    <div class="input-group">
        <input type="text" id="itemName" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: åˆé¤)" required>
    </div>
    <div class="input-group">
        <input type="number" id="itemAmount" placeholder="é‡‘é¡" required>
    </div>
    <div class="input-group">
        <input type="date" id="itemDate" required>
    </div>
    
    <button id="submitBtn">æ–°å¢ç´€éŒ„</button>
    <button id="cancelBtn">å–æ¶ˆä¿®æ”¹</button>
    <div id="statusMsg"></div>

    <ul id="expenseList">
        <li style="justify-content:center; color:#888;">è¼‰å…¥è³‡æ–™ä¸­...</li>
    </ul>
</div>

<script type="module">
    // 1. å¼•å…¥å¿…è¦çš„ Firebase å‡½å¼åº«
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        onSnapshot, 
        doc, 
        deleteDoc, 
        updateDoc,
        query,
        orderBy,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. æ‚¨çš„ Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyALj-w6MSC_5CgGCVUVFveoV8-ykRxcu24",
        authDomain: "crm-1225-003.firebaseapp.com",
        projectId: "crm-1225-003",
        storageBucket: "crm-1225-003.firebasestorage.app",
        messagingSenderId: "566985177794",
        appId: "1:566985177794:web:fcf21c033bd62c3bd7195b"
    };

    // 3. åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dbCollection = "expenses"; // è³‡æ–™åº«é›†åˆåç¨±

    // DOM å…ƒç´ 
    const itemNameInput = document.getElementById('itemName');
    const itemAmountInput = document.getElementById('itemAmount');
    const itemDateInput = document.getElementById('itemDate');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const expenseList = document.getElementById('expenseList');
    const statusMsg = document.getElementById('statusMsg');

    // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
    itemDateInput.valueAsDate = new Date();

    // è®Šæ•¸ï¼šç”¨ä¾†è¨˜éŒ„ç¾åœ¨æ˜¯å¦æ­£åœ¨ã€Œç·¨è¼¯æ¨¡å¼ã€ä»¥åŠæ­£åœ¨ç·¨è¼¯å“ªä¸€ç­† ID
    let isEditing = false;
    let currentEditId = null;

    // --- åŠŸèƒ½å‡½å¼ ---

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showMessage(msg, type) {
        statusMsg.textContent = msg;
        statusMsg.className = type;
        setTimeout(() => {
            statusMsg.textContent = "";
            statusMsg.className = "";
        }, 3000);
    }

    // é‡ç½®è¡¨å–®
    function resetForm() {
        itemNameInput.value = '';
        itemAmountInput.value = '';
        itemDateInput.valueAsDate = new Date();
        isEditing = false;
        currentEditId = null;
        submitBtn.textContent = "æ–°å¢ç´€éŒ„";
        submitBtn.style.backgroundColor = "#28a745";
        cancelBtn.style.display = "none";
    }

    // 4. ç›£è½è³‡æ–™åº«è®ŠåŒ– (Read) - å³æ™‚æ›´æ–°åˆ—è¡¨
    const q = query(collection(db, dbCollection), orderBy("date", "desc"));
    
    onSnapshot(q, (snapshot) => {
        expenseList.innerHTML = ""; // æ¸…ç©ºåˆ—è¡¨
        if (snapshot.empty) {
            expenseList.innerHTML = `<li style="justify-content:center; color:#888;">ç›®å‰æ²’æœ‰ç´€éŒ„</li>`;
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="item-info">
                    <span class="item-name">${data.name}</span>
                    <span class="item-date">${data.date}</span>
                </div>
                <div style="font-weight:bold; margin-right:15px;">$${data.amount}</div>
                <div class="actions">
                    <button class="edit-btn" data-id="${doc.id}" data-name="${data.name}" data-amount="${data.amount}" data-date="${data.date}">ç·¨è¼¯</button>
                    <button class="delete-btn" data-id="${doc.id}">åˆªé™¤</button>
                </div>
            `;
            expenseList.appendChild(li);
        });

        // ç¶å®šæŒ‰éˆ•äº‹ä»¶ (å› ç‚ºæ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¦åœ¨ç”Ÿæˆå¾Œç¶å®š)
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDelete);
        });
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', handleEditSetup);
        });
    });

    // 5. æ–°å¢æˆ–æ›´æ–°è³‡æ–™ (Create / Update)
    submitBtn.addEventListener('click', async () => {
        const name = itemNameInput.value.trim();
        const amount = Number(itemAmountInput.value);
        const date = itemDateInput.value;

        if (!name || !amount || !date) {
            showMessage("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼", "error");
            return;
        }

        submitBtn.disabled = true;

        try {
            if (isEditing) {
                // æ›´æ–°æ¨¡å¼
                const docRef = doc(db, dbCollection, currentEditId);
                await updateDoc(docRef, {
                    name: name,
                    amount: amount,
                    date: date,
                    updatedAt: serverTimestamp()
                });
                showMessage("ä¿®æ”¹æˆåŠŸï¼", "success");
            } else {
                // æ–°å¢æ¨¡å¼
                await addDoc(collection(db, dbCollection), {
                    name: name,
                    amount: amount,
                    date: date,
                    createdAt: serverTimestamp()
                });
                showMessage("æ–°å¢æˆåŠŸï¼", "success");
            }
            resetForm();
        } catch (e) {
            console.error("Error: ", e);
            showMessage("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™", "error");
        } finally {
            submitBtn.disabled = false;
        }
    });

    // 6. åˆªé™¤è³‡æ–™ (Delete)
    async function handleDelete(e) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        
        const id = e.target.getAttribute('data-id');
        try {
            await deleteDoc(doc(db, dbCollection, id));
            showMessage("åˆªé™¤æˆåŠŸ", "success");
            // å¦‚æœæ­£åœ¨ç·¨è¼¯é€™ç­†è¢«åˆªé™¤çš„è³‡æ–™ï¼Œå¼·åˆ¶é‡ç½®
            if (currentEditId === id) resetForm(); 
        } catch (e) {
            showMessage("åˆªé™¤å¤±æ•—", "error");
        }
    }

    // æº–å‚™ç·¨è¼¯è³‡æ–™ (å°‡è³‡æ–™å¡«å›è¼¸å…¥æ¡†)
    function handleEditSetup(e) {
        const btn = e.target;
        currentEditId = btn.getAttribute('data-id');
        itemNameInput.value = btn.getAttribute('data-name');
        itemAmountInput.value = btn.getAttribute('data-amount');
        itemDateInput.value = btn.getAttribute('data-date');

        isEditing = true;
        submitBtn.textContent = "ç¢ºèªä¿®æ”¹";
        submitBtn.style.backgroundColor = "#ffc107"; // é»ƒè‰²
        cancelBtn.style.display = "block";
        
        window.scrollTo({ top: 0, behavior: 'smooth' }); // æ²å‹•åˆ°ä¸Šæ–¹
    }

    // å–æ¶ˆä¿®æ”¹
    cancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetForm();
    });

</script>

</body>
</html>