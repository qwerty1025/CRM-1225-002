<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾Šå¥¶é…é€ç®¡ç† v6.8 - æ™ºæ…§é€£ç·šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // æ›´æ–°ç‚ºæ‚¨æä¾›çš„ 002 å°ˆæ¡ˆæ†‘è­‰
        const firebaseConfig = {
            apiKey: "AIzaSyBLnhjqSEdXWn-HD0rg6liHcygj4-9FcIQ",
            authDomain: "crm-ts-1225-002.firebaseapp.com",
            projectId: "crm-ts-1225-002",
            storageBucket: "crm-ts-1225-002.firebasestorage.app",
            messagingSenderId: "855566092078",
            appId: "1:855566092078:web:064e295a48082a291a9cbf",
            databaseURL: "https://crm-ts-1225-002-default-rtdb.firebaseio.com"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getDatabase(app);
            window.dbRef = ref;
            window.dbUpdate = update;
            window.dbOnValue = onValue;
            console.log("Firebase æ¨¡çµ„è¼‰å…¥æˆåŠŸ");
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col relative">
        
        <div v-if="showLogModal" class="fixed inset-0 bg-slate-900/80 z-[100] flex items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-xl overflow-hidden animate__animated animate__zoomIn">
                <div class="bg-slate-800 p-5 flex justify-between items-center">
                    <h3 class="text-white font-bold flex items-center gap-2">
                        <span v-if="uploading" class="animate-spin text-blue-400">ğŸŒ€</span>
                        <span v-else class="text-emerald-400">ğŸ“Š</span>
                        è³‡æ–™åŒæ­¥é€²åº¦èˆ‡åµéŒ¯
                    </h3>
                </div>
                <div class="p-4 bg-black h-80 overflow-y-auto font-mono text-[11px] leading-relaxed">
                    <div v-for="(log, idx) in logs" :key="idx" :class="log.type === 'error' ? 'text-rose-400' : 'text-emerald-400'" class="mb-1">
                        <span class="text-slate-600">[{{ log.time }}]</span> {{ log.msg }}
                        <div v-if="log.hint" class="mt-1 mb-2 p-2 bg-rose-950 text-rose-200 rounded border border-rose-800">
                            ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š{{ log.hint }}
                        </div>
                    </div>
                    <div v-if="uploading" class="text-blue-400 animate-pulse mt-2">>>> æ­£åœ¨èˆ‡ Firebase å³æ™‚è³‡æ–™åº«é€šè¨Šä¸­...</div>
                </div>
                <div class="p-4 bg-slate-100 flex justify-between items-center">
                    <span class="text-xs text-slate-400">å°ˆæ¡ˆ ID: crm-ts-1225-002</span>
                    <button v-if="!uploading" @click="showLogModal=false" class="bg-slate-800 text-white px-8 py-2 rounded-xl hover:bg-black transition shadow-lg">é—œé–‰æ§åˆ¶å°</button>
                </div>
            </div>
        </div>

        <nav class="bg-white border-b border-slate-200 p-4 sticky top-0 z-50 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">ç¾Š</div>
                <h1 class="font-black text-slate-800 tracking-tight">ç¾Šå¥¶é…é€ç®¡ç† <span class="text-[10px] bg-slate-100 px-1 rounded">V6.8</span></h1>
            </div>
            <div class="flex bg-slate-100 p-1 rounded-2xl">
                <button @click="currentView='manager'" :class="currentView==='manager'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-5 py-2 rounded-xl text-sm font-bold transition">ç¶“ç†</button>
                <button @click="currentView='delivery'" :class="currentView==='delivery'?'bg-white shadow text-indigo-600':'text-slate-500'" class="px-5 py-2 rounded-xl text-sm font-bold transition">é…é€</button>
            </div>
        </nav>

        <main class="flex-grow p-4 lg:p-8 max-w-6xl mx-auto w-full">

            <div v-if="currentView === 'manager'" class="space-y-6">
                
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="flex bg-slate-50/50 border-b border-slate-100">
                        <button @click="inputMode='manual'" :class="inputMode==='manual'?'bg-white text-indigo-600 border-b-2 border-indigo-600':'text-slate-400'" class="flex-1 py-4 text-sm font-bold transition">æ‰‹å‹•å¡«å¯« / å¿«é€Ÿç¯„æœ¬</button>
                        <button @click="inputMode='csv'" :class="inputMode==='csv'?'bg-white text-indigo-600 border-b-2 border-indigo-600':'text-slate-400'" class="flex-1 py-4 text-sm font-bold transition">Google Sheets åŒæ­¥</button>
                    </div>

                    <div class="p-6">
                        <div v-if="inputMode==='manual'" class="animate__animated animate__fadeIn space-y-5">
                            <div class="bg-indigo-50/50 p-3 rounded-2xl border border-indigo-100">
                                <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest block mb-2">å¿«é€Ÿæ¨¡æ“¬è³‡æ–™è¼‰å…¥</span>
                                <div class="flex flex-wrap gap-2">
                                    <button v-for="(demo, idx) in demoTemplates" :key="idx" @click="loadDemo(demo)" 
                                            class="px-3 py-1.5 bg-white border border-indigo-200 rounded-xl text-xs hover:bg-indigo-600 hover:text-white transition shadow-sm">
                                        ç¯„æœ¬{{idx+1}}: {{demo.name}}
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1">é †åº</label><input v-model.number="manualForm.order" type="number" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl"></div>
                                <div><label class="text-[10px] font-bold text-slate-400 block mb-1">åç¨±</label><input v-model="manualForm.name" type="text" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl"></div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 block mb-1">å€åŸŸ (ä¸‹æ‹‰é¸æ“‡)</label>
                                    <select v-model="manualForm.area" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl appearance-none">
                                        <option value="ä¸‰å³½å¤§åŸ”">ä¸‰å³½å¤§åŸ”</option>
                                        <option value="é¶¯æ­Œå¸‚å€">é¶¯æ­Œå¸‚å€</option>
                                        <option value="æ¨¹æ—æŸ‘åœ’">æ¨¹æ—æŸ‘åœ’</option>
                                        <option value="åœŸåŸå¸‚å€">åœŸåŸå¸‚å€</option>
                                        <option value="è‡¨æ™‚é»">è‡¨æ™‚é»</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 block mb-1">é€±æœŸ (ä¸‹æ‹‰é¸æ“‡)</label>
                                    <select v-model="manualForm.cycle" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl">
                                        <option value="æ¯å¤©">æ¯å¤©</option>
                                        <option value="(ä¸€)~(äº”)">(ä¸€)~(äº”)</option>
                                        <option value="é€±æœ«å…­æ—¥">é€±æœ«å…­æ—¥</option>
                                        <option value="å–®é€±é…é€">å–®é€±é…é€</option>
                                        <option value="è‡¨æ™‚è¨‚å–®">è‡¨æ™‚è¨‚å–®</option>
                                    </select>
                                </div>
                            </div>

                            <div class="overflow-x-auto border border-slate-100 rounded-2xl bg-slate-50/30">
                                <table class="w-full text-[11px] text-center border-collapse">
                                    <thead class="bg-slate-100 text-slate-500 uppercase">
                                        <tr><th class="p-2">é€±</th><th>åŸ</th><th>ç”œ</th><th>å·§</th><th>è“</th><th>é»‘</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr v-for="(day, dIdx) in weekDays" :key="dIdx">
                                            <td class="p-2 font-bold text-slate-400">{{day}}</td>
                                            <td v-for="fIdx in 5" :key="fIdx" class="p-1">
                                                <input v-model.number="manualForm.pattern[dIdx*5 + (fIdx-1)]" type="number" 
                                                       class="w-8 h-8 p-0 text-center bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button @click="addManualToPreview" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 hover:bg-indigo-700 transition active:scale-95">
                                â• åŠ å…¥é è¦½æ ¸å°æ¸…å–®
                            </button>
                        </div>

                        <div v-if="inputMode==='csv'" class="animate__animated animate__fadeIn">
                            <input v-model="sheetUrl" type="text" placeholder="è²¼ä¸Š Google Sheets CSV ç¶²å€..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <button @click="previewSheet" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-black transition">è§£æä¸¦è¼‰å…¥é è¦½</button>
                        </div>
                    </div>
                </div>

                <div v-if="previewItems.length > 0" class="bg-white rounded-3xl shadow-xl border-2 border-amber-400 overflow-hidden animate__animated animate__fadeInUp">
                    <div class="p-5 bg-amber-50 border-b border-amber-200 flex justify-between items-center">
                        <div>
                            <h2 class="font-black text-amber-900 flex items-center gap-2"><span>âš ï¸</span> å¾…å¯«å…¥é è¦½ ({{previewItems.length}} ç­†)</h2>
                            <p class="text-[10px] text-amber-600">è³‡æ–™å°šæœªé€²å…¥è³‡æ–™åº«ï¼Œè«‹æ ¸å°å¾ŒæŒ‰ä¸‹ç¢ºèªä¸Šå‚³ã€‚</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="clearPreview" class="px-4 py-2 text-slate-400 text-xs font-bold">æ¸…ç©ºå–æ¶ˆ</button>
                            <button @click="confirmUpload" class="bg-amber-500 text-white px-8 py-3 rounded-2xl font-black shadow-lg shadow-amber-200 hover:bg-amber-600">ğŸ’¾ ç¢ºèªä¸Šå‚³è³‡æ–™åº«</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-amber-100/50 sticky top-0 font-bold text-amber-800">
                                <tr><th class="p-3">é †åº</th><th class="p-3">å§“å</th><th class="p-3">å€åŸŸ</th><th class="p-3 text-center">æ¯é€±ç“¶æ•¸</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in previewItems" :key="item.tempId" class="border-b border-amber-100 hover:bg-white">
                                    <td class="p-3 font-mono text-amber-700">{{item.order}}</td>
                                    <td class="p-3 font-bold">{{item.name}}</td>
                                    <td class="p-3 text-xs text-amber-600">{{item.area}}</td>
                                    <td class="p-3 text-center font-black">{{item.pattern.reduce((a,b)=>a+b,0)}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 bg-slate-50 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">ğŸŒ é›²ç«¯è³‡æ–™åº«ç¾æ³ ({{sortedCustomers.length}} ç­†)</h2>
                        <button @click="generateDailyLogs" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition">æ›´æ–°é…é€å ±è¡¨</button>
                    </div>
                    <div class="overflow-x-auto max-h-[400px]">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-white sticky top-0 shadow-sm text-slate-400 uppercase text-[10px] font-black">
                                <tr><th class="p-4">åº</th><th class="p-4">å§“å</th><th class="p-4 text-center" v-for="d in weekDays" :key="d">{{d}}</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="cust in sortedCustomers" :key="cust.id" class="hover:bg-indigo-50/30 transition">
                                    <td class="p-4 font-mono text-slate-400 text-xs">{{cust.order}}</td>
                                    <td class="p-4 font-bold text-slate-700">{{cust.name}} <span class="block text-[9px] font-normal text-slate-400">{{cust.area}}</span></td>
                                    <td v-for="i in 7" :key="i" class="p-4 text-center">
                                        <span v-if="getDaySum(cust.pattern, i-1) > 0" class="bg-indigo-600 text-white w-5 h-5 inline-flex items-center justify-center rounded-full text-[10px] font-black shadow-lg shadow-indigo-100">
                                            {{getDaySum(cust.pattern, i-1)}}
                                        </span>
                                        <span v-else class="text-slate-100">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'delivery'" class="max-w-md mx-auto space-y-4">
                <div class="bg-white shadow-2xl shadow-indigo-100 rounded-[40px] p-6 border border-slate-100 flex justify-between items-center sticky top-20 z-40">
                    <button @click="changeDate(-1)" class="w-14 h-14 flex items-center justify-center bg-slate-50 rounded-3xl active:scale-90 transition">â—€</button>
                    <div class="text-center">
                        <div class="text-indigo-600 font-black text-[10px] tracking-[4px] uppercase mb-1">{{getWeekDayName(selectedDate)}}</div>
                        <div class="text-3xl font-black text-slate-800">{{selectedDate.substring(5)}}</div>
                    </div>
                    <button @click="changeDate(1)" class="w-14 h-14 flex items-center justify-center bg-slate-50 rounded-3xl active:scale-90 transition">â–¶</button>
                </div>

                <div v-if="sortedDailyList.length > 0" class="space-y-4 pb-24 animate__animated animate__fadeIn">
                    <div v-for="item in sortedDailyList" :key="item.id" class="bg-white rounded-[32px] p-6 shadow-sm border border-slate-100 relative transition-all" :class="item.status==='delivered'?'opacity-30 grayscale scale-[0.98]':''">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-slate-900 text-white text-[10px] px-2 py-0.5 rounded-lg font-mono">{{item.order}}</span>
                                    <h3 class="font-black text-2xl text-slate-800">{{item.name}}</h3>
                                </div>
                                <div class="flex flex-wrap gap-1.5 mb-4">
                                    <template v-for="(q, t) in item.items"><span v-if="q>0" class="px-3 py-1.5 rounded-2xl text-[11px] font-black border" :class="flavorStyle(t)">{{flavorName(t)}} {{q}}</span></template>
                                </div>
                                <p class="text-[11px] text-slate-400 font-bold bg-slate-50 p-2 rounded-xl inline-block">{{item.area}} Â· {{item.note || 'ç„¡ç‰¹åˆ¥æ¶ˆæ¯'}}</p>
                            </div>
                            <button @click="toggleStatus(item)" class="w-20 h-20 rounded-[28px] border-4 flex items-center justify-center text-4xl transition-all shadow-xl" :class="item.status==='delivered'?'bg-emerald-500 border-emerald-100 text-white shadow-emerald-200':'bg-white border-slate-50 text-slate-100'">
                                {{item.status==='delivered'?'âœ“':'â—‹'}}
                            </button>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-20 text-slate-300 font-bold italic">ğŸ˜´ æœ¬æ—¥å°šç„¡é…é€è³‡æ–™</div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const currentView = ref('manager');
                const inputMode = ref('manual');
                const selectedDate = ref(new Date().toISOString().split('T')[0]);
                const sheetUrl = ref('');
                const loading = ref(false);
                const customers = ref({});
                const dailyData = ref({});
                
                // Log & Debug è¦–çª—
                const showLogModal = ref(false);
                const uploading = ref(false);
                const logs = ref([]);

                // é è¦½æ ¸å°å€
                const previewItems = ref([]);
                const manualForm = reactive({ order:null, name:'', area:'ä¸‰å³½å¤§åŸ”', cycle:'æ¯å¤©', pattern: new Array(35).fill(0) });
                const weekDays = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];

                // 5 çµ„å…§å»ºæ¸¬è©¦æ¨¡æ“¬å…§å®¹
                const demoTemplates = [
                    { name: "ç‹å¤§åŸ” (ç¯„ä¾‹)", area: "ä¸‰å³½å¤§åŸ”", cycle: "æ¯å¤©", pattern: [1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0] },
                    { name: "æ—ä¸‰å³½ (ç¯„ä¾‹)", area: "ä¸‰å³½å¤§åŸ”", cycle: "(ä¸€)~(äº”)", pattern: [1,1,0,0,0, 1,1,0,0,0, 1,1,0,0,0, 1,1,0,0,0, 1,1,0,0,0, 0,0,0,0,0, 0,0,0,0,0] },
                    { name: "é™³é¶¯æ­Œ (ç¯„ä¾‹)", area: "é¶¯æ­Œå¸‚å€", cycle: "é€±æœ«å…­æ—¥", pattern: [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 2,0,0,0,0, 2,0,0,0,0] },
                    { name: "å¼µæŸ‘åœ’ (ç¯„ä¾‹)", area: "æ¨¹æ—æŸ‘åœ’", cycle: "æ¯å¤©", pattern: [1,0,1,0,0, 1,0,1,0,0, 1,0,1,0,0, 1,0,1,0,0, 1,0,1,0,0, 1,0,1,0,0, 1,0,1,0,0] },
                    { name: "åœŸåŸè‡¨æ™‚ (ç¯„ä¾‹)", area: "åœŸåŸå¸‚å€", cycle: "è‡¨æ™‚è¨‚å–®", pattern: [0,0,0,0,0, 0,0,0,0,0, 5,5,5,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0] }
                ];

                // ç›£è½ Firebase
                onMounted(() => {
                    if (window.dbOnValue) {
                        window.dbOnValue(window.dbRef(window.db, 'customers'), s => customers.value = s.val() || {});
                        loadDailyData(selectedDate.value);
                    }
                });

                function addLog(msg, type='info', hint='') {
                    const time = new Date().toTimeString().split(' ')[0];
                    logs.value.push({ time, msg, type, hint });
                }

                function loadDemo(demo) {
                    manualForm.name = demo.name;
                    manualForm.area = demo.area;
                    manualForm.cycle = demo.cycle;
                    manualForm.pattern = [...demo.pattern];
                    manualForm.order = Object.keys(customers.value).length + 1;
                }

                function addManualToPreview() {
                    if(!manualForm.name || !manualForm.order) return alert("è«‹å¡«å¯«å§“åèˆ‡é †åº");
                    previewItems.value.push({
                        tempId: Date.now(),
                        name: manualForm.name,
                        order: manualForm.order,
                        area: manualForm.area,
                        cycle: manualForm.cycle,
                        pattern: [...manualForm.pattern]
                    });
                    manualForm.name = '';
                    manualForm.order++;
                }

                async function confirmUpload() {
                    showLogModal.value = true;
                    uploading.value = true;
                    logs.value = [];
                    addLog("æº–å‚™åŒæ­¥è‡³ Firebase 002 å°ˆæ¡ˆ...");

                    const updates = {};
                    previewItems.value.forEach(item => {
                        const dbId = `cust_${item.order.toString().padStart(3,'0')}`;
                        updates[`customers/${dbId}`] = {
                            name: item.name, order: item.order, area: item.area, cycle: item.cycle, pattern: item.pattern
                        };
                        addLog(`æ’ç¨‹å¯«å…¥: [${item.order}] ${item.name}`);
                    });

                    try {
                        addLog("å˜—è©¦å¯«å…¥é›²ç«¯è³‡æ–™åº«...");
                        await window.dbUpdate(window.dbRef(window.db), updates);
                        addLog("âœ… å¯«å…¥æˆåŠŸï¼é ç«¯è³‡æ–™å·²æ›´æ–°ã€‚");
                        previewItems.value = [];
                    } catch (e) {
                        addLog(`âŒ å¯«å…¥å¤±æ•—: ${e.code}`, 'error', "è«‹é€²å…¥ Firebase æ§åˆ¶å° -> Realtime Database -> è¦å‰‡ï¼Œå°‡ã€.readã€èˆ‡ã€.writeã€è¨­ç‚º trueã€‚");
                        addLog(`éŒ¯èª¤è©³æƒ…: ${e.message}`, 'error', "æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ– databaseURL æ˜¯å¦æ­£ç¢º (æ‡‰ç‚º crm-ts-1225-002-default-rtdb)ã€‚");
                    }
                    uploading.value = false;
                }

                // CSV è§£æ (ç•¥ç¸®)
                async function previewSheet() {
                    if(!sheetUrl.value) return;
                    loading.value = true;
                    try {
                        const r = await fetch(sheetUrl.value);
                        const t = await r.text();
                        const rows = t.split('\n').slice(1);
                        rows.forEach(row => {
                            const c = row.split(',').map(s=>s.trim());
                            if (parseInt(c[1]) > 0) {
                                previewItems.value.push({
                                    tempId: Math.random(), name: c[2], order: parseInt(c[1]), 
                                    area: c[3]||'æœªå®šç¾©', cycle: c[0], pattern: c.slice(4, 39).map(n=>parseInt(n)||0)
                                });
                            }
                        });
                        addLog(`æˆåŠŸå¾ç¶²å€è¼‰å…¥ ${rows.length} ç­†æš«å­˜è³‡æ–™`);
                    } catch(e) { alert("è®€å–éŒ¯èª¤"); }
                    loading.value = false;
                }

                function clearPreview() { previewItems.value = []; }

                // å ±è¡¨èˆ‡æ—¥æœŸ
                async function generateDailyLogs() {
                    if(!confirm("å³å°‡é‡ç®— 2025/12~2026/01 é…é€å–®ï¼Œç¢ºèªï¼Ÿ")) return;
                    showLogModal.value = true; uploading.value = true; logs.value = [];
                    const updates = {};
                    const start = new Date("2025-12-01");
                    const end = new Date("2026-01-31");
                    
                    Object.entries(customers.value).forEach(([id, c]) => {
                        addLog(`è¨ˆç®—å ±è¡¨: ${c.name}`);
                        for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                            const dStr = d.toISOString().split('T')[0];
                            let pIdx = d.getDay()===0?6:d.getDay()-1;
                            const items = { original: c.pattern[pIdx*5]||0, sweet: c.pattern[pIdx*5+1]||0, choco: c.pattern[pIdx*5+2]||0, strawberry: c.pattern[pIdx*5+3]||0, brown: c.pattern[pIdx*5+4]||0 };
                            if(Object.values(items).reduce((a,b)=>a+b,0)>0) updates[`daily_operations/${dStr}/${id}`] = { name:c.name, order:c.order, area:c.area, items, status:'pending', note:'' };
                        }
                    });
                    await window.dbUpdate(window.dbRef(window.db), updates);
                    uploading.value = false; addLog("âœ… å ±è¡¨ç”Ÿæˆå®Œç•¢ï¼");
                }

                function loadDailyData(d) { window.dbOnValue(window.dbRef(window.db, `daily_operations/${d}`), s => dailyData.value = s.val() || {}); }
                const changeDate = (n) => { const d=new Date(selectedDate.value); d.setDate(d.getDate()+n); selectedDate.value=d.toISOString().split('T')[0]; loadDailyData(selectedDate.value); }
                const toggleStatus = (i) => window.dbUpdate(window.dbRef(window.db, `daily_operations/${selectedDate.value}/${i.id}`), {status: i.status==='delivered'?'pending':'delivered'});

                const sortedCustomers = computed(() => Object.entries(customers.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const sortedDailyList = computed(() => Object.entries(dailyData.value).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.order-b.order));
                const getDaySum = (p,i) => p?p.slice(i*5,i*5+5).reduce((a,b)=>a+b,0):0;
                const getWeekDayName = (d) => ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][new Date(d).getDay()];
                const flavorName = (k)=>({original:'åŸ',sweet:'ç”œ',choco:'å·§',strawberry:'è“',brown:'é»‘'}[k]);
                const flavorStyle = (k)=>({original:'bg-blue-50 text-blue-700 border-blue-200',sweet:'bg-pink-50 text-pink-700 border-pink-200',choco:'bg-amber-50 text-amber-800 border-amber-200',strawberry:'bg-red-50 text-red-700 border-red-200',brown:'bg-yellow-50 text-yellow-800 border-yellow-200'}[k]);

                return {
                    currentView, inputMode, sheetUrl, loading, manualForm, weekDays, demoTemplates,
                    previewItems, showLogModal, logs, uploading, sortedCustomers, sortedDailyList, selectedDate,
                    loadDemo, addManualToPreview, previewSheet, confirmUpload, clearPreview, generateDailyLogs,
                    changeDate, toggleStatus, getDaySum, getWeekDayName, flavorName, flavorStyle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>